USE master;
GO

CREATE DATABASE BD_SALUDCONNECT;
GO

USE BD_SALUDCONNECT;
GO

-- Tabla Roles
CREATE TABLE TB_ROLES (
    ID_ROLE INT PRIMARY KEY IDENTITY(1,1),
    NAME_ROLE VARCHAR(20) NOT NULL,
    FLG_DELETE BIT DEFAULT 0
);
GO

INSERT INTO TB_ROLES (NAME_ROLE) VALUES
('Paciente'),
('Administrador'),
('Doctor');
GO

-- Tabla Especialidades
CREATE TABLE TB_SPECIALTIES (
    ID_SPECIALTY INT PRIMARY KEY IDENTITY(1,1),
    NAME_SPECIALTY VARCHAR(50) NOT NULL,
    FLG_DELETE BIT DEFAULT 0
);
GO

INSERT INTO TB_SPECIALTIES (NAME_SPECIALTY) VALUES
('Cardiología'),
('Dermatología'),
('Neurología'),
('Pediatría');
GO

-- Tabla Usuarios (pacientes y doctores)
CREATE TABLE TB_USERS (
    ID_USER INT PRIMARY KEY IDENTITY(1,1),
    FIRST_NAME VARCHAR(50) NOT NULL,
    LAST_NAME_PAT VARCHAR(50) NOT NULL,  
    LAST_NAME_MAT VARCHAR(50) NOT NULL, 
    DOCUMENT VARCHAR(9) NOT NULL UNIQUE,
    EMAIL VARCHAR(100) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR(255) NOT NULL, 
    ID_ROLE INT NOT NULL REFERENCES TB_ROLES(ID_ROLE),
    FLG_DELETE BIT DEFAULT 0,
    CREATED_AT DATETIME DEFAULT GETDATE(),
    UPDATED_AT DATETIME DEFAULT GETDATE()
);
GO

INSERT INTO TB_USERS (FIRST_NAME, LAST_NAME_MAT, LAST_NAME_PAT, DOCUMENT, EMAIL, PASSWORD_HASH, ID_ROLE) VALUES
('Juan', 'González', 'Pérez', '123456789', 'juan.perez@example.com', 'clave123', 1),  -- Paciente
('Ana', 'Martínez', 'López', '987654321', 'ana.lopez@example.com', 'clave123', 2),   -- Administrador
('Carlos', 'Sánchez', 'Ramírez', '456789123', 'carlos.ramirez@example.com', 'clave123', 3),  -- Doctor
('Laura', 'Gómez', 'Fernández', '789123456', 'laura.fernandez@example.com', 'clave123', 3); -- Doctor
GO

-- Tabla Servicios vinculados a una especialidad
CREATE TABLE TB_SERVICES (
    ID_SERVICE INT PRIMARY KEY IDENTITY(1,1),
    NAME_SERVICE VARCHAR(30) NOT NULL,
    PRICE DECIMAL(10,2) NOT NULL,
    DURATION_MINUTES INT NOT NULL,
    ID_SPECIALTY INT NOT NULL REFERENCES TB_SPECIALTIES(ID_SPECIALTY),
    FLG_DELETE BIT DEFAULT 0
);
GO

INSERT INTO TB_SERVICES (NAME_SERVICE, PRICE, DURATION_MINUTES, ID_SPECIALTY) VALUES
('Consulta Cardiología', 150.00, 30, 1),
('Consulta Dermatología', 120.00, 25, 2),
('Consulta Neurología', 200.00, 40, 3),
('Consulta Pediatría', 100.00, 20, 4);
GO

-- Tabla para relacionar doctores con sus especialidades y experiencia
CREATE TABLE TB_DOCTOR_SPECIALTIES (
    ID_DOCTOR INT NOT NULL REFERENCES TB_USERS(ID_USER),
    ID_SPECIALTY INT NOT NULL REFERENCES TB_SPECIALTIES(ID_SPECIALTY),
    YEARS_EXPERIENCE INT DEFAULT 0,
    PRIMARY KEY (ID_DOCTOR, ID_SPECIALTY)
);
GO

INSERT INTO TB_DOCTOR_SPECIALTIES (ID_DOCTOR, ID_SPECIALTY, YEARS_EXPERIENCE) VALUES
(3, 1, 10),  -- Carlos Ramírez: Cardiología, 10 años experiencia
(4, 2, 5);
GO

-- Tabla Citas (con servicio y doctores/pacientes)
CREATE TABLE TB_APPOINTMENTS (
    ID_APPOINTMENT INT PRIMARY KEY IDENTITY(1,1),
    ID_PATIENT INT NOT NULL REFERENCES TB_USERS(ID_USER),
    ID_DOCTOR INT NOT NULL REFERENCES TB_USERS(ID_USER),
    ID_SERVICE INT NOT NULL REFERENCES TB_SERVICES(ID_SERVICE),
    DATE_APPOINTMENT DATE NOT NULL,
    STATE CHAR(1) NOT NULL,
    CONSTRAINT CHK_STATE CHECK (STATE IN ('A','P','X','N')),
    CREATED_AT DATETIME DEFAULT GETDATE(),
    UPDATED_AT DATETIME DEFAULT GETDATE()
);
GO

INSERT INTO TB_APPOINTMENTS (ID_PATIENT, ID_DOCTOR, ID_SERVICE, DATE_APPOINTMENT, STATE) VALUES
(1, 3, 1, '2025-10-01', 'A'),
(1, 4, 2, '2025-10-10', 'X');
GO