USE BD_SALUDCONNECT;
GO

/* ============================================
   PROCEDURES SESSION
   ============================================ */

IF OBJECT_ID('SP_LOGIN_USER', 'P') IS NOT NULL
    DROP PROCEDURE SP_LOGIN_USER;
GO

CREATE PROCEDURE SP_LOGIN_USER
    @EMAIL VARCHAR(100),
    @PASSWORD VARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        U.ID_USER,
        U.FIRST_NAME,
        U.LAST_NAME_PAT,
        U.LAST_NAME_MAT,
        U.DOCUMENT,
        U.EMAIL,
        U.BIRTHDATE,
        U.GENDER,
        U.PHONE,
        U.ID_ROLE,
		U.PROFILE_PICTURE,
        R.NAME_ROLE
    FROM TB_USERS U
    INNER JOIN TB_ROLES R ON U.ID_ROLE = R.ID_ROLE
    WHERE U.EMAIL = @EMAIL AND U.PASSWORD_HASH = @PASSWORD AND U.FLG_DELETE = 0;

    IF EXISTS (
        SELECT 1
        FROM TB_USERS U
        WHERE U.EMAIL = @EMAIL AND U.PASSWORD_HASH = @PASSWORD AND U.FLG_DELETE = 0 AND U.ID_ROLE = 3
    )
    BEGIN
        SELECT 
            DS.ID_SPECIALTY,
            DS.YEARS_EXPERIENCE,
            S.NAME_SPECIALTY
        FROM TB_USERS U
        INNER JOIN TB_DOCTOR_SPECIALTIES DS ON U.ID_USER = DS.ID_DOCTOR
        INNER JOIN TB_SPECIALTIES S ON DS.ID_SPECIALTY = S.ID_SPECIALTY
        WHERE U.EMAIL = @EMAIL AND U.PASSWORD_HASH = @PASSWORD AND U.FLG_DELETE = 0;
    END
END
GO

IF OBJECT_ID('SP_REGISTER_PATIENTS', 'P') IS NOT NULL
    DROP PROCEDURE SP_REGISTER_PATIENTS;
GO

CREATE PROCEDURE SP_REGISTER_PATIENTS
    @FIRST_NAME VARCHAR(50),
    @LAST_NAME_PAT VARCHAR(50),
    @LAST_NAME_MAT VARCHAR(50),
    @DOCUMENT VARCHAR(9),
    @BIRTHDATE DATE,
    @PHONE VARCHAR(13),
    @GENDER CHAR(1),
    @EMAIL VARCHAR(100),
    @PASSWORD_HASH VARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM TB_USERS WHERE DOCUMENT = @DOCUMENT)
    BEGIN
        RAISERROR('El número de documento %s ya existe', 16, 1, @DOCUMENT);
        RETURN;
    END

    IF EXISTS (SELECT 1 FROM TB_USERS WHERE EMAIL = @EMAIL)
    BEGIN
        RAISERROR('El correo electrónico %s ya existe', 16, 1, @EMAIL);
        RETURN;
    END

    INSERT INTO TB_USERS(FIRST_NAME, LAST_NAME_PAT, LAST_NAME_MAT, DOCUMENT, BIRTHDATE, PHONE, GENDER, EMAIL, PASSWORD_HASH, ID_ROLE)
    VALUES(@FIRST_NAME, @LAST_NAME_PAT, @LAST_NAME_MAT, @DOCUMENT, @BIRTHDATE, @PHONE, @GENDER, @EMAIL, @PASSWORD_HASH, 1);

    SELECT SCOPE_IDENTITY() AS ID_USER;
END
GO

IF OBJECT_ID('SP_UPDATE_PROFILE_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_UPDATE_PROFILE_DOCTOR;
GO

CREATE PROCEDURE SP_UPDATE_PROFILE_DOCTOR
	@ID_USER INT,
    @Email VARCHAR(100) = NULL,
    @ProfilePicture VARCHAR(200) = NULL,
    @PasswordHash VARCHAR(255) = NULL
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE TB_USERS
    SET
        Email = CASE WHEN @Email IS NOT NULL AND @Email <> '' THEN @Email ELSE Email END,
		Profile_Picture = 
    CASE 
        WHEN @ProfilePicture IS NOT NULL AND @ProfilePicture <> '' THEN @ProfilePicture
        WHEN @ProfilePicture = '' THEN NULL
        ELSE Profile_Picture
    END,
        Password_Hash = CASE WHEN @PasswordHash IS NOT NULL AND @PasswordHash <> '' THEN @PasswordHash ELSE Password_Hash END
    WHERE ID_USER = @ID_USER;
END
GO

/* ============================================
   PROCEDURES MEDICAL RECORDS
   ============================================ */
IF OBJECT_ID('SP_INSERT_RECORD_WITH_SERVICES', 'P') IS NOT NULL
    DROP PROCEDURE SP_INSERT_RECORD_WITH_SERVICES;
GO

CREATE PROCEDURE SP_INSERT_RECORD_WITH_SERVICES
    @IdAppointment INT,
    @Observations VARCHAR(2000),
    @Diagnosis VARCHAR(500) = NULL,
    @Treatment VARCHAR(2000) = NULL,
    @ServiceIds VARCHAR(MAX) = NULL,
    @NewRecordID INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;

        INSERT INTO TB_MEDICAL_RECORDS (ID_APPOINTMENT, OBSERVATIONS, DIAGNOSIS, TREATMENT)
        VALUES (@IdAppointment, @Observations, @Diagnosis, @Treatment);

        SET @NewRecordID = SCOPE_IDENTITY();

        IF @ServiceIds IS NOT NULL AND LTRIM(RTRIM(@ServiceIds)) <> ''
        BEGIN
            INSERT INTO TB_ADDITIONAL_SERVICES (ID_RECORD, ID_SERVICE, PRICE_AT_TIME, STATE)
            SELECT
                @NewRecordID,
                TRY_CAST(value AS INT),
                S.PRICE,
                'P' 
            FROM STRING_SPLIT(@ServiceIds, ',') AS split
            INNER JOIN TB_SERVICES S ON S.ID_SERVICE = TRY_CAST(split.value AS INT)
            WHERE TRY_CAST(split.value AS INT) IS NOT NULL;
        END
        COMMIT;
    END TRY
    BEGIN CATCH
        ROLLBACK;
        THROW;
    END CATCH
END;

/* ============================================
   PROCEDURES SPECIALTY
   ============================================ */
IF OBJECT_ID('SP_LIST_SPECIALTIES', 'P') IS NOT NULL
    DROP PROCEDURE SP_LIST_SPECIALTIES;
GO

CREATE PROCEDURE SP_LIST_SPECIALTIES
AS
BEGIN
	SELECT ID_SPECIALTY,NAME_SPECIALTY FROM TB_SPECIALTIES
END
GO
/* ============================================
   PROCEDURES SERVICES
   ============================================ */

IF OBJECT_ID('SP_LIST_SERVICES_FOR_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_LIST_SERVICES_FOR_DOCTOR;
GO

CREATE PROCEDURE SP_LIST_SERVICES_FOR_DOCTOR
    @IDDOCTOR INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        S.ID_SERVICE,
        S.NAME_SERVICE,
        S.DESCRIPTION,
        S.PRICE,
        S.DURATION_MINUTES, 
        SPE.ID_SPECIALTY, 
        SPE.NAME_SPECIALTY 
    FROM TB_SERVICES S
    INNER JOIN TB_SPECIALTIES SPE ON S.ID_SPECIALTY = SPE.ID_SPECIALTY
    INNER JOIN TB_DOCTOR_SPECIALTIES D ON D.ID_SPECIALTY = S.ID_SPECIALTY
    WHERE D.ID_DOCTOR = @IDDOCTOR AND S.FLG_DELETE = 0
    ORDER BY SPE.NAME_SPECIALTY, S.NAME_SERVICE;
END
GO

IF OBJECT_ID('SP_TOTAL_SERVICES', 'P') IS NOT NULL
    DROP PROCEDURE SP_TOTAL_SERVICES;
GO

CREATE PROCEDURE SP_TOTAL_SERVICES
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS totalServices
    FROM TB_SERVICES 
    WHERE FLG_DELETE = 0;
END
GO

IF OBJECT_ID('SP_MIN_SERVICE', 'P') IS NOT NULL
    DROP PROCEDURE SP_MIN_SERVICE;
GO

CREATE PROCEDURE SP_MIN_SERVICE
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MIN(DURATION_MINUTES) AS MinDuration
    FROM TB_SERVICES
    WHERE FLG_DELETE = 0;
END
GO

IF OBJECT_ID('SP_LIST_SERVICES_BY_SPECIALTY', 'P') IS NOT NULL
    DROP PROCEDURE SP_LIST_SERVICES_BY_SPECIALTY;
GO

CREATE PROCEDURE SP_LIST_SERVICES_BY_SPECIALTY
    @IdSpecialty INT = NULL 
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        S.ID_SERVICE, 
        S.NAME_SERVICE, 
        S.DESCRIPTION, 
        S.PRICE, 
        S.DURATION_MINUTES,
        SP.ID_SPECIALTY,
        SP.NAME_SPECIALTY
    FROM TB_SERVICES S
    INNER JOIN TB_SPECIALTIES SP ON S.ID_SPECIALTY = SP.ID_SPECIALTY
    WHERE (@IdSpecialty IS NULL OR S.ID_SPECIALTY = @IdSpecialty);
END
GO

/* ============================================
   PROCEDURES APPOINTMENTS
   ============================================ */

IF OBJECT_ID('SP_APPOINTMENTS_TODAY_FOR_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_APPOINTMENTS_TODAY_FOR_DOCTOR;
GO

CREATE PROCEDURE SP_APPOINTMENTS_TODAY_FOR_DOCTOR
    @IDDOCTOR INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS AppointmentsToday
    FROM TB_APPOINTMENTS
    WHERE 
        ID_DOCTOR = @IDDOCTOR
        AND CAST(DATE_APPOINTMENT AS DATE) = CAST(GETDATE() AS DATE);
END
GO

IF OBJECT_ID('SP_TOTAL_PATIENTS_FOR_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_TOTAL_PATIENTS_FOR_DOCTOR;
GO

CREATE PROCEDURE SP_TOTAL_PATIENTS_FOR_DOCTOR
    @IDDOCTOR INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(DISTINCT ID_PATIENT) AS TotalUniquePatients
    FROM TB_APPOINTMENTS
    WHERE ID_DOCTOR = @IDDOCTOR;
END
GO

IF OBJECT_ID('SP_TOTAL_APPOINTMENTS_COMPLETED', 'P') IS NOT NULL
    DROP PROCEDURE SP_TOTAL_APPOINTMENTS_COMPLETED;
GO

CREATE PROCEDURE SP_TOTAL_APPOINTMENTS_COMPLETED
    @IDDOCTOR INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS CompletedAppointments
    FROM TB_APPOINTMENTS
    WHERE ID_DOCTOR = @IDDOCTOR AND STATE = 'A';
END
GO

IF OBJECT_ID('SP_COUNT_UPCOMMING_APPOINTMENTS_FOR_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_COUNT_UPCOMMING_APPOINTMENTS_FOR_DOCTOR;
GO

CREATE PROCEDURE SP_COUNT_UPCOMMING_APPOINTMENTS_FOR_DOCTOR
    @IDDOCTOR INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS UpcomingAppointments
    FROM TB_APPOINTMENTS
    WHERE 
        ID_DOCTOR = @IDDOCTOR 
        AND DATE_APPOINTMENT > GETDATE()
        AND STATE = 'P'; 
END
GO

IF OBJECT_ID('SP_LIST_APPOINTMENTS_BY_DATE_FOR_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_LIST_APPOINTMENTS_BY_DATE_FOR_DOCTOR;
GO

CREATE PROCEDURE SP_LIST_APPOINTMENTS_BY_DATE_FOR_DOCTOR
    @DoctorId INT,
    @Date DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        A.ID_APPOINTMENT,
        P.ID_USER AS PatientId,
        P.FIRST_NAME,
        P.LAST_NAME_PAT,
        P.LAST_NAME_MAT,
        CAST(A.DATE_APPOINTMENT AS DATE) AS DateOnly,
        CONVERT(VARCHAR(5), A.DATE_APPOINTMENT, 108) AS AppointmentTime, 
        A.STATE,
        S.NAME_SPECIALTY,
        A.APPOINTMENT_PRICE,
        MR.ID_RECORD 
    FROM TB_APPOINTMENTS A
    INNER JOIN TB_USERS P ON A.ID_PATIENT = P.ID_USER
    INNER JOIN TB_SPECIALTIES S ON A.ID_SPECIALTY = S.ID_SPECIALTY
    LEFT JOIN TB_MEDICAL_RECORDS MR ON A.ID_APPOINTMENT = MR.ID_APPOINTMENT
    WHERE A.ID_DOCTOR = @DoctorId
      AND (@Date IS NULL OR CAST(A.DATE_APPOINTMENT AS DATE) = @Date)
    ORDER BY A.DATE_APPOINTMENT;
END
GO

IF OBJECT_ID('SP_GET_APPOINTMENTS_FOR_7_DAYS', 'P') IS NOT NULL
    DROP PROCEDURE SP_GET_APPOINTMENTS_FOR_7_DAYS;
GO

CREATE PROCEDURE SP_GET_APPOINTMENTS_FOR_7_DAYS
    @DoctorId INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        CAST(DATE_APPOINTMENT AS DATE) AS AppointmentDate,
        COUNT(*) AS TotalAppointments
    FROM TB_APPOINTMENTS
    WHERE 
        DATE_APPOINTMENT >= CAST(GETDATE() - 6 AS DATE) 
        AND DATE_APPOINTMENT < CAST(GETDATE() + 1 AS DATE) 
        AND STATE IN ('A', 'P', 'X', 'N')
        AND (@DoctorId IS NULL OR ID_DOCTOR = @DoctorId)
    GROUP BY 
        CAST(DATE_APPOINTMENT AS DATE)
    ORDER BY 
        AppointmentDate;
END
GO

IF OBJECT_ID('SP_GET_APPOINTEMNT_FOR_ID', 'P') IS NOT NULL
    DROP PROCEDURE SP_GET_APPOINTEMNT_FOR_ID;
GO

CREATE PROCEDURE SP_GET_APPOINTEMNT_FOR_ID
    @ID_APPOINTMENT INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Información de la cita
    SELECT 
        A.ID_APPOINTMENT,
        P.ID_USER AS PatientId,
        P.FIRST_NAME,
        P.LAST_NAME_PAT,
        P.LAST_NAME_MAT,
        P.DOCUMENT,
        P.BIRTHDATE,
        P.PHONE,
        P.GENDER,
        P.EMAIL,
        CAST(A.DATE_APPOINTMENT AS DATE) AS DateOnly,
        CONVERT(VARCHAR(5), A.DATE_APPOINTMENT, 108) AS AppointmentTime, 
        A.STATE,
        S.ID_SPECIALTY,
        S.NAME_SPECIALTY,
        A.APPOINTMENT_PRICE,
        C.NUMBER_CONSULTORIES,
        C.FLOOR_NUMBER,
        D.ID_USER AS DoctorId,
        D.FIRST_NAME AS DoctorFirstName,
        D.LAST_NAME_PAT AS DoctorLastNamePat,
        D.LAST_NAME_MAT AS DoctorLastNameMat,
        -- Información del registro médico si existe
        MR.ID_RECORD,
        MR.DATE_REPORT,
        MR.OBSERVATIONS,
        MR.DIAGNOSIS,
        MR.TREATMENT
    FROM TB_APPOINTMENTS A
    INNER JOIN TB_USERS P ON A.ID_PATIENT = P.ID_USER
    INNER JOIN TB_USERS D ON A.ID_DOCTOR = D.ID_USER
    INNER JOIN TB_SPECIALTIES S ON A.ID_SPECIALTY = S.ID_SPECIALTY
    INNER JOIN TB_CONSULTORIES C ON A.ID_CONSULTORIES = C.ID_CONSULTORIES
    LEFT JOIN TB_MEDICAL_RECORDS MR ON A.ID_APPOINTMENT = MR.ID_APPOINTMENT
    WHERE A.ID_APPOINTMENT = @ID_APPOINTMENT;

    -- Si existe registro médico, traer también los servicios adicionales
    IF EXISTS (SELECT 1 FROM TB_MEDICAL_RECORDS WHERE ID_APPOINTMENT = @ID_APPOINTMENT)
    BEGIN
        SELECT 
            ADS.ID_ADD_SERVICE,
            ADS.ID_RECORD,
            ADS.ID_SERVICE,
            ADS.STATE,
            S.NAME_SERVICE,
            S.DESCRIPTION,
            S.PRICE,
            S.DURATION_MINUTES,
            SPE.NAME_SPECIALTY
        FROM TB_MEDICAL_RECORDS MR
        INNER JOIN TB_ADDITIONAL_SERVICES ADS ON MR.ID_RECORD = ADS.ID_RECORD
        INNER JOIN TB_SERVICES S ON ADS.ID_SERVICE = S.ID_SERVICE
        INNER JOIN TB_SPECIALTIES SPE ON S.ID_SPECIALTY = SPE.ID_SPECIALTY
        WHERE MR.ID_APPOINTMENT = @ID_APPOINTMENT
        ORDER BY ADS.ID_ADD_SERVICE;
    END
END
GO

IF OBJECT_ID('SP_APPOINTMENT_CHANGE_STATE', 'P') IS NOT NULL
    DROP PROCEDURE SP_APPOINTMENT_CHANGE_STATE;
GO

CREATE PROC SP_APPOINTMENT_CHANGE_STATE
	@IDAPPOINTMENT INT,
	@STATE CHAR(1)
AS
BEGIN
	UPDATE TB_APPOINTMENTS
	SET STATE = @STATE
	WHERE ID_APPOINTMENT = @IDAPPOINTMENT
END
GO

/* ============================================
   PROCEDURES SPECIALTIES
   ============================================ */

IF OBJECT_ID('SP_TOTAL_SPECIALTIES', 'P') IS NOT NULL
    DROP PROCEDURE SP_TOTAL_SPECIALTIES;
GO

CREATE PROCEDURE SP_TOTAL_SPECIALTIES
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS totalSpecialties
    FROM TB_SPECIALTIES 
    WHERE FLG_DELETE = 0;
END
GO

/* ============================================
   PROCEDURES DOCTOR
   ============================================ */

IF OBJECT_ID('SP_TOTAL_DOCTOR', 'P') IS NOT NULL
    DROP PROCEDURE SP_TOTAL_DOCTOR;
GO

CREATE PROCEDURE SP_TOTAL_DOCTOR
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS totalDoctors
    FROM TB_USERS
    WHERE ID_ROLE = 3 AND FLG_DELETE = 0;
END
GO

/* ============================================
   PROCEDURES USER
   ============================================ */

IF OBJECT_ID('SP_GET_USER_PROFILE', 'P') IS NOT NULL
    DROP PROCEDURE SP_GET_USER_PROFILE;
GO

CREATE PROCEDURE SP_GET_USER_PROFILE
    @ID_USER INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        U.ID_USER,
        U.FIRST_NAME,
        U.LAST_NAME_PAT,
        U.LAST_NAME_MAT,
        U.DOCUMENT,
        U.BIRTHDATE,
        U.PHONE,
        U.GENDER,
        U.EMAIL,
        U.ID_ROLE,
        R.NAME_ROLE,
        U.PROFILE_PICTURE,
        U.DATE_REGISTER,
        EC.NAMES_CONTACT,
        EC.LAST_NAME_PAT AS EmergencyLastNamePat,
        EC.LAST_NAME_MAT AS EmergencyLastNameMat,
        EC.PHONE_EMERGENCY,
        REL.DESCRIPTION_RELATIONSHIP
    FROM TB_USERS U
    INNER JOIN TB_ROLES R ON U.ID_ROLE = R.ID_ROLE
    LEFT JOIN TB_EMERGENCY_CONTACT EC ON U.ID_E_CONTACT = EC.ID_E_CONTACT
    LEFT JOIN TB_RELATIONSHIP REL ON EC.ID_RELATIONSHIP = REL.ID_RELATIONSHIP
    WHERE U.ID_USER = @ID_USER AND U.FLG_DELETE = 0;

    IF EXISTS (SELECT 1 FROM TB_USERS WHERE ID_USER = @ID_USER AND ID_ROLE = 3 AND FLG_DELETE = 0)
    BEGIN
        SELECT 
            DS.ID_SPECIALTY,
            S.NAME_SPECIALTY,
            DS.YEARS_EXPERIENCE
        FROM TB_DOCTOR_SPECIALTIES DS
        INNER JOIN TB_SPECIALTIES S ON DS.ID_SPECIALTY = S.ID_SPECIALTY
        WHERE DS.ID_DOCTOR = @ID_USER;
    END
END
GO

/* ============================================
   PROCEDURES ADMIN
   ============================================ */

IF OBJECT_ID('SP_Total_Appointments', 'P') IS NOT NULL
    DROP PROCEDURE SP_Total_Appointments;
GO

CREATE PROCEDURE SP_Total_Appointments
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS TotalAppointments
    FROM TB_APPOINTMENTS;
END
GO

/* ============================================
   PROCEDURES PACIENTE-CLIENTE
   Estados: A=Atendido, P=Pendiente, X=Cancelado, N=No asistió
   ============================================ */

IF OBJECT_ID('sp_total_citas', 'P') IS NOT NULL
    DROP PROCEDURE sp_total_citas;
GO

CREATE PROCEDURE sp_total_citas
    @idPaciente INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS Total_Citas 
    FROM TB_APPOINTMENTS
    WHERE ID_PATIENT = @idPaciente;
END
GO

IF OBJECT_ID('sp_total_citas_asistidas', 'P') IS NOT NULL
    DROP PROCEDURE sp_total_citas_asistidas;
GO

CREATE PROCEDURE sp_total_citas_asistidas
    @idPaciente INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS Citas_Asistidas 
    FROM TB_APPOINTMENTS
    WHERE ID_PATIENT = @idPaciente AND STATE = 'A';
END
GO

IF OBJECT_ID('sp_total_citas_pendientes', 'P') IS NOT NULL
    DROP PROCEDURE sp_total_citas_pendientes;
GO

CREATE PROCEDURE sp_total_citas_pendientes
    @idPaciente INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS Citas_Pendientes 
    FROM TB_APPOINTMENTS
    WHERE ID_PATIENT = @idPaciente AND STATE = 'P';
END
GO

IF OBJECT_ID('sp_total_citas_canceladas', 'P') IS NOT NULL
    DROP PROCEDURE sp_total_citas_canceladas;
GO

CREATE PROCEDURE sp_total_citas_canceladas
    @idPaciente INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS Citas_Canceladas 
    FROM TB_APPOINTMENTS
    WHERE ID_PATIENT = @idPaciente AND STATE = 'X';
END
GO

IF OBJECT_ID('sp_proximas_citas', 'P') IS NOT NULL
    DROP PROCEDURE sp_proximas_citas;
GO

CREATE PROCEDURE sp_proximas_citas
    @idPaciente INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        a.ID_APPOINTMENT,
        CONCAT(d.FIRST_NAME, ' ', d.LAST_NAME_PAT, ' ', d.LAST_NAME_MAT) AS Nombres_Completos,
        s.NAME_SPECIALTY,
        FORMAT(a.DATE_APPOINTMENT, 'HH:mm') AS Hora_Cita,
        FORMAT(a.DATE_APPOINTMENT, 'dd/MM/yyyy') AS Fecha_Cita,
        a.STATE,
        a.APPOINTMENT_PRICE,
        c.NUMERO_CONSULTORIO,
        c.FLOOR_NUMBER
    FROM TB_APPOINTMENTS a
    INNER JOIN TB_USERS d ON a.ID_DOCTOR = d.ID_USER
    INNER JOIN TB_SPECIALTIES s ON a.ID_SPECIALTY = s.ID_SPECIALTY
    INNER JOIN TB_CONSULTORIOS c ON a.ID_CONSULTORIO = c.ID_CONSULTORIO
    WHERE a.ID_PATIENT = @idPaciente 
        AND a.DATE_APPOINTMENT >= CAST(GETDATE() AS DATE)
        AND a.STATE = 'P'
    ORDER BY a.DATE_APPOINTMENT ASC;
END
GO

IF OBJECT_ID('sp_total_doctores', 'P') IS NOT NULL
    DROP PROCEDURE sp_total_doctores;
GO

CREATE PROCEDURE sp_total_doctores
AS
BEGIN
    SET NOCOUNT ON;

    SELECT COUNT(*) AS total_Doctores 
    FROM TB_USERS 
    WHERE ID_ROLE = 3 AND FLG_DELETE = 0;
END
GO

/* ============================================
   PROCEDURES SCHEDULES
   ============================================ */

IF OBJECT_ID('SP_CALCULAR_CAPACIDAD_SEGUN_HORARIO', 'P') IS NOT NULL
    DROP PROCEDURE SP_CALCULAR_CAPACIDAD_SEGUN_HORARIO;
GO

CREATE PROCEDURE SP_CALCULAR_CAPACIDAD_SEGUN_HORARIO
    @ScheduleID INT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @StartTime DATETIME;
    DECLARE @EndTime DATETIME;
    DECLARE @SlotDuration INT;
    DECLARE @TotalMinutes DECIMAL(10, 2);
    DECLARE @MaxCapacity INT;

    SELECT
        @StartTime = FECHA_INICIO,
        @EndTime = FECHA_FIN,
        @SlotDuration = DURACION_CITA
    FROM TB_DOCTOR_SCHEDULES
    WHERE ID_SCHEDULE = @ScheduleID;

    IF @StartTime IS NULL
    BEGIN
        SELECT 
            0 AS MaxCapacity, 
            0 AS TotalMinutesInShift,
            0 AS SlotDurationMinutes,
            'Error: Horario no encontrado.' AS StatusMessage;
        RETURN;
    END

    SET @TotalMinutes = DATEDIFF(MINUTE, @StartTime, @EndTime);

    IF @SlotDuration <= 0
    BEGIN
        SELECT 
            0 AS MaxCapacity, 
            @TotalMinutes AS TotalMinutesInShift,
            @SlotDuration AS SlotDurationMinutes,
            'Error: Duración de cita inválida.' AS StatusMessage;
        RETURN;
    END

    SET @MaxCapacity = FLOOR(@TotalMinutes / @SlotDuration);

    SELECT
        @MaxCapacity AS MaxCapacity,
        @TotalMinutes AS TotalMinutesInShift,
        @SlotDuration AS SlotDurationMinutes,
        'Cálculo exitoso' AS StatusMessage;
END
GO

/* ============================================
   PROCEDURES MEDICAL RECORDS
   ============================================ */

IF OBJECT_ID('SP_CREATE_OR_UPDATE_MEDICAL_RECORD', 'P') IS NOT NULL
    DROP PROCEDURE SP_CREATE_OR_UPDATE_MEDICAL_RECORD;
GO

CREATE PROCEDURE SP_CREATE_OR_UPDATE_MEDICAL_RECORD
    @ID_APPOINTMENT INT,
    @OBSERVATIONS VARCHAR(2000),
    @DIAGNOSIS VARCHAR(500) = NULL,
    @TREATMENT VARCHAR(2000) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM TB_APPOINTMENTS WHERE ID_APPOINTMENT = @ID_APPOINTMENT)
    BEGIN
        RAISERROR('La cita con ID %d no existe', 16, 1, @ID_APPOINTMENT);
        RETURN;
    END

    IF NOT EXISTS (SELECT 1 FROM TB_APPOINTMENTS WHERE ID_APPOINTMENT = @ID_APPOINTMENT AND STATE = 'A')
    BEGIN
        RAISERROR('La cita debe estar en estado Atendida (A) para crear un registro médico', 16, 1);
        RETURN;
    END

    IF EXISTS (SELECT 1 FROM TB_MEDICAL_RECORDS WHERE ID_APPOINTMENT = @ID_APPOINTMENT)
    BEGIN
        UPDATE TB_MEDICAL_RECORDS
        SET 
            DATE_REPORT = GETDATE(),
            OBSERVATIONS = @OBSERVATIONS,
            DIAGNOSIS = @DIAGNOSIS,
            TREATMENT = @TREATMENT
        WHERE ID_APPOINTMENT = @ID_APPOINTMENT;

        SELECT 
            ID_RECORD,
            'Registro médico actualizado exitosamente' AS Mensaje
        FROM TB_MEDICAL_RECORDS
        WHERE ID_APPOINTMENT = @ID_APPOINTMENT;
    END
    ELSE
    BEGIN
        INSERT INTO TB_MEDICAL_RECORDS (ID_APPOINTMENT, OBSERVATIONS, DIAGNOSIS, TREATMENT)
        VALUES (@ID_APPOINTMENT, @OBSERVATIONS, @DIAGNOSIS, @TREATMENT);

        SELECT 
            SCOPE_IDENTITY() AS ID_RECORD,
            'Registro médico creado exitosamente' AS Mensaje;
    END
END
GO

IF OBJECT_ID('SP_GET_MEDICAL_RECORD_BY_APPOINTMENT', 'P') IS NOT NULL
    DROP PROCEDURE SP_GET_MEDICAL_RECORD_BY_APPOINTMENT;
GO

CREATE PROCEDURE SP_GET_MEDICAL_RECORD_BY_APPOINTMENT
    @ID_APPOINTMENT INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        MR.ID_RECORD,
        MR.ID_APPOINTMENT,
        MR.DATE_REPORT,
        MR.OBSERVATIONS,
        MR.DIAGNOSIS,
        MR.TREATMENT,
        A.ID_PATIENT,
        A.ID_DOCTOR,
        A.ID_SPECIALTY,
        A.DATE_APPOINTMENT,
        A.STATE,
        A.APPOINTMENT_PRICE
    FROM TB_MEDICAL_RECORDS MR
    INNER JOIN TB_APPOINTMENTS A ON MR.ID_APPOINTMENT = A.ID_APPOINTMENT
    WHERE MR.ID_APPOINTMENT = @ID_APPOINTMENT;
END
GO

IF OBJECT_ID('SP_GET_PATIENT_MEDICAL_HISTORY', 'P') IS NOT NULL
    DROP PROCEDURE SP_GET_PATIENT_MEDICAL_HISTORY;
GO

CREATE PROCEDURE SP_GET_PATIENT_MEDICAL_HISTORY
    @ID_PATIENT INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        MR.ID_RECORD,
        MR.ID_APPOINTMENT,
        MR.DATE_REPORT,
        MR.OBSERVATIONS,
        MR.DIAGNOSIS,
        MR.TREATMENT,
        A.DATE_APPOINTMENT,
        A.APPOINTMENT_PRICE,
        A.STATE AS AppointmentState,
        D.FIRST_NAME AS DoctorFirstName,
        D.LAST_NAME_PAT AS DoctorLastNamePat,
        D.LAST_NAME_MAT AS DoctorLastNameMat,
        S.NAME_SPECIALTY,
        C.NUMERO_CONSULTORIO
    FROM TB_MEDICAL_RECORDS MR
    INNER JOIN TB_APPOINTMENTS A ON MR.ID_APPOINTMENT = A.ID_APPOINTMENT
    INNER JOIN TB_USERS D ON A.ID_DOCTOR = D.ID_USER
    INNER JOIN TB_SPECIALTIES S ON A.ID_SPECIALTY = S.ID_SPECIALTY
    INNER JOIN TB_CONSULTORIOS C ON A.ID_CONSULTORIO = C.ID_CONSULTORIO
    WHERE A.ID_PATIENT = @ID_PATIENT
    ORDER BY MR.DATE_REPORT DESC;
END
GO

/* ============================================
   PROCEDURES ADDITIONAL SERVICES
   ============================================ */

IF OBJECT_ID('SP_ADD_ADDITIONAL_SERVICE', 'P') IS NOT NULL
    DROP PROCEDURE SP_ADD_ADDITIONAL_SERVICE;
GO

CREATE PROCEDURE SP_ADD_ADDITIONAL_SERVICE
    @ID_RECORD INT,
    @ID_SERVICE INT
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM TB_MEDICAL_RECORDS WHERE ID_RECORD = @ID_RECORD)
    BEGIN
        RAISERROR('El registro médico con ID %d no existe', 16, 1, @ID_RECORD);
        RETURN;
    END

    IF NOT EXISTS (SELECT 1 FROM TB_SERVICES WHERE ID_SERVICE = @ID_SERVICE AND FLG_DELETE = 0)
    BEGIN
        RAISERROR('El servicio con ID %d no existe o está eliminado', 16, 1, @ID_SERVICE);
        RETURN;
    END

    IF EXISTS (SELECT 1 FROM TB_ADDITIONAL_SERVICES WHERE ID_RECORD = @ID_RECORD AND ID_SERVICE = @ID_SERVICE)
    BEGIN
        RAISERROR('El servicio ya está asociado a este registro médico', 16, 1);
        RETURN;
    END

    INSERT INTO TB_ADDITIONAL_SERVICES (ID_RECORD, ID_SERVICE, STATE)
    VALUES (@ID_RECORD, @ID_SERVICE, 'P');

    SELECT 
        SCOPE_IDENTITY() AS ID_ADD_SERVICE,
        'Servicio adicional agregado exitosamente' AS Mensaje;
END
GO

IF OBJECT_ID('SP_LIST_ADDITIONAL_SERVICES_BY_RECORD', 'P') IS NOT NULL
    DROP PROCEDURE SP_LIST_ADDITIONAL_SERVICES_BY_RECORD;
GO

CREATE PROCEDURE SP_LIST_ADDITIONAL_SERVICES_BY_RECORD
    @ID_RECORD INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ADS.ID_ADD_SERVICE,
        ADS.ID_RECORD,
        ADS.ID_SERVICE,
        ADS.STATE,
        S.NAME_SERVICE,
        S.DESCRIPTION,
        S.PRICE,
        S.DURATION_MINUTES,
        SPE.ID_SPECIALTY,
        SPE.NAME_SPECIALTY
    FROM TB_ADDITIONAL_SERVICES ADS
    INNER JOIN TB_SERVICES S ON ADS.ID_SERVICE = S.ID_SERVICE
    INNER JOIN TB_SPECIALTIES SPE ON S.ID_SPECIALTY = SPE.ID_SPECIALTY
    WHERE ADS.ID_RECORD = @ID_RECORD
    ORDER BY ADS.ID_ADD_SERVICE;
END
GO

IF OBJECT_ID('SP_UPDATE_ADDITIONAL_SERVICE_STATE', 'P') IS NOT NULL
    DROP PROCEDURE SP_UPDATE_ADDITIONAL_SERVICE_STATE;
GO

CREATE PROCEDURE SP_UPDATE_ADDITIONAL_SERVICE_STATE
    @ID_ADD_SERVICE INT,
    @STATE CHAR(1)
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM TB_ADDITIONAL_SERVICES WHERE ID_ADD_SERVICE = @ID_ADD_SERVICE)
    BEGIN
        RAISERROR('El servicio adicional con ID %d no existe', 16, 1, @ID_ADD_SERVICE);
        RETURN;
    END

    IF @STATE NOT IN ('P', 'A', 'X')
    BEGIN
        RAISERROR('Estado inválido. Use: P=Pendiente, A=Aprobado, X=Cancelado', 16, 1);
        RETURN;
    END

    UPDATE TB_ADDITIONAL_SERVICES
    SET STATE = @STATE
    WHERE ID_ADD_SERVICE = @ID_ADD_SERVICE;

    SELECT 'Estado del servicio adicional actualizado exitosamente' AS Mensaje;
END
GO

IF OBJECT_ID('SP_CALCULATE_ADDITIONAL_SERVICES_TOTAL', 'P') IS NOT NULL
    DROP PROCEDURE SP_CALCULATE_ADDITIONAL_SERVICES_TOTAL;
GO

CREATE PROCEDURE SP_CALCULATE_ADDITIONAL_SERVICES_TOTAL
    @ID_RECORD INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        @ID_RECORD AS ID_RECORD,
        COUNT(*) AS TotalServices,
        ISNULL(SUM(S.PRICE), 0) AS TotalCost
    FROM TB_ADDITIONAL_SERVICES ADS
    INNER JOIN TB_SERVICES S ON ADS.ID_SERVICE = S.ID_SERVICE
    WHERE ADS.ID_RECORD = @ID_RECORD AND ADS.STATE != 'X';
END
GO