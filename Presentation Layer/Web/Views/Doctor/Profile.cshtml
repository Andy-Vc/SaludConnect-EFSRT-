@model Web.Models.ViewModels.DoctorVM.ProfileVM

@{
	// Mantiene la lógica de C# igual
	Layout = "~/Views/Shared/_LayoutDoctor.cshtml";
	ViewData["Title"] = "Mi Perfil";
	var user = Model?.User;
	var specialty = user?.DoctorSpecialties?.FirstOrDefault();
	var edad = DateTime.Today.Year - user.BirthDate.Year;
	if (user.BirthDate.Date > DateTime.Today.AddYears(-edad)) edad--;
	var initials = $"{user.FirstName[0]}{user.LastNamePat[0]}".ToUpper();
	string GetBadgeClass(string state) => state switch
	{
		"X" => "bg-danger",
		"N" => "bg-warning",
		"A" => "bg-success",
		"P" => "bg-info",
		_ => "bg-secondary"
	};

	string GetStateText(string state) => state switch
	{
		"X" => "Cancelada",
		"N" => "No asistió",
		"A" => "Asistió",
		"P" => "Pendiente",
		_ => "Desconocido"
	};
	var mainGradientStyle = "background: linear-gradient(to right, #2563eb, #06b6d4);";
}

@if (user == null)
{
	<div>No se encontró información del usuario.</div>
}
else
{
	<section class="position-relative pt-4 pb-3 px-3 overflow-hidden" style="background: linear-gradient(to right, #eff6ff, #ecfeff);">
		<div class="container position-relative">
			<div class="mx-auto">
				<h1 class="fw-bold h3 text-dark mb-2">Mi Perfil</h1>
				<p class="lead text-secondary mx-auto">
					Información esencial y visión general de la actividad como profesional de la salud.
				</p>
			</div>
		</div>
	</section>

	<div class="container py-5">
		<div class="card border-0 rounded-4 shadow-lg mb-5" style="background-color: #ffffff;">
			<div class="card-body p-4 p-md-5">
				<div class="row g-4 align-items-center">

					<div class="col-md-4 text-center border-md-end">
						<img src="https://ui-avatars.com/api/?name=@initials&background=0D8ABC&color=fff&size=180"
							 alt="Foto de perfil"
							 class="img-fluid rounded-circle shadow-lg mb-3"
							 style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #06b6d4;">

						<h3 class="mt-3 mb-0 fw-bold text-dark">
							@(user.Gender == "F" ? "Dra." : "Dr.") @user.FirstName @user.LastNamePat
						</h3>
						<span class="badge text-white fw-bold" style="@mainGradientStyle">Activo</span>
					</div>

					<div class="col-md-8">
						<h4 class="fw-bold text-dark mb-4">Detalles Personales y Profesionales</h4>
						<div class="row gy-3">
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Correo electrónico:</label>
								<p class="text-dark mb-0 fw-medium">@user.Email</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Documento de Identidad:</label>
								<p class="text-dark mb-0 fw-medium">@user.Document</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Teléfono:</label>
								<p class="text-dark mb-0 fw-medium">@user.Phone</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Género:</label>
								<p class="text-dark mb-0 fw-medium">@(user.Gender == "M" ? "Masculino" : "Femenino")</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Edad:</label>
								<p class="text-dark mb-0 fw-medium">@edad años</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Especialidad:</label>
								<p class="text-dark mb-0 fw-medium">@specialty?.Specialty.NameSpecialty</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Años de experiencia:</label>
								<p class="text-dark mb-0 fw-medium">@specialty?.YearsExperience años</p>
							</div>
							<div class="col-sm-6">
								<label class="fw-semibold text-secondary small">Fecha de Nacimiento:</label>
								<p class="text-dark mb-0 fw-medium">@user.BirthDate.ToString("dd/MM/yyyy")</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<section class="card border-0 rounded-4 shadow-sm p-4">
			<h3 class="fw-bold mb-4 text-dark d-flex align-items-center">
				<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-3" viewBox="0 0 24 24">
					<rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
					<path d="M16 2v4M8 2v4M3 10h18" />
				</svg>
				Historial de Citas
			</h3>

			<!-- Buscador de Pacientes -->
			<div class="d-flex justify-content-center mb-4">
				<form method="get" asp-action="Profile" asp-controller="Doctor" class="d-flex align-items-center" style="width: 100%; max-width: 500px;">
					<div class="position-relative flex-grow-1">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							 class="position-absolute top-50 translate-middle-y"
							 style="left: 1rem; z-index: 10;" aria-hidden="true">
							<circle cx="11" cy="11" r="8"></circle>
							<path d="m21 21-4.35-4.35"></path>
						</svg>
						<input type="text"
							   name="searchPatient"
							   value="@ViewBag.SearchPatient"
							   class="form-control ps-5 pe-3 border-2 shadow-sm"
							   placeholder="Buscar por nombre del paciente..."
							   aria-label="Buscar paciente"
							   style="height: 3rem; border-radius: 12px; border-color: #e2e8f0; transition: all 0.3s ease;"
							   onfocus="this.style.borderColor='#2563eb'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'"
							   onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 1px 2px 0 rgba(0, 0, 0, 0.05)'">
					</div>

					<button type="submit"
							class="btn btn-primary ms-2 d-flex align-items-center justify-content-center shadow-sm"
							style="height: 3rem; width: 3rem; border-radius: 12px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border: none; transition: all 0.3s ease;"
							onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.4)'"
							onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 1px 2px 0 rgba(0, 0, 0, 0.05)'"
							title="Buscar">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="8"></circle>
							<path d="m21 21-4.35-4.35"></path>
						</svg>
					</button>

					@if (!string.IsNullOrEmpty(ViewBag.SearchPatient as string))
					{
						<a href="@Url.Action("Profile", "Doctor")"
						   class="btn btn-outline-secondary ms-2 d-flex align-items-center justify-content-center shadow-sm"
						   style="height: 3rem; width: 3rem; border-radius: 12px; border: 2px solid #e2e8f0; transition: all 0.3s ease;"
						   onmouseover="this.style.backgroundColor='#fee2e2'; this.style.borderColor='#ef4444'; this.style.transform='scale(1.05)'"
						   onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#e2e8f0'; this.style.transform='scale(1)'"
						   title="Limpiar búsqueda">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M18 6 6 18M6 6l12 12"></path>
							</svg>
						</a>
					}
				</form>
			</div>

			<!-- Mensaje de resultados de búsqueda -->
			@if (!string.IsNullOrEmpty(ViewBag.SearchPatient as string))
			{
				<div class="alert alert-info border-0 rounded-3 mb-4 d-flex align-items-center" style="background: linear-gradient(to right, #dbeafe, #e0f2fe);">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#2563eb" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
						<path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
					</svg>
					<span class="text-dark fw-medium">Mostrando resultados para: <strong>"@ViewBag.SearchPatient"</strong></span>
				</div>
			}

			<div class="table-responsive">
				<table class="table table-hover align-middle mb-0">
					<thead style="background: linear-gradient(to right, #f0f9ff, #f0fdfa);">
						<tr>
							<th class="fw-semibold text-dark py-3">Paciente</th>
							<th class="fw-semibold text-dark py-3">Fecha</th>
							<th class="fw-semibold text-dark py-3">Hora</th>
							<th class="fw-semibold text-dark py-3">Servicio</th>
							<th class="fw-semibold text-dark py-3">Estado</th>
							<th class="fw-semibold text-dark py-3">Comprobante</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var appt in Model.Appointments)
						{
							<tr class="border-bottom">
								<td class="text-dark fw-medium py-3">@appt.Patient.FirstName @appt.Patient.LastNamePat @appt.Patient.LastNameMat</td>
								<td class="py-3">@appt.DateAppointment.ToString("dd/MM/yyyy")</td>
								<td class="py-3">@appt.DateAppointment.ToString("hh:mm tt")</td>
								<td class="py-3">@appt.Specialty.NameSpecialty</td>
								<td class="py-3">
									<span class="badge fw-medium text-white px-2 py-1 @GetBadgeClass(appt.State)" style="min-width: 90px; text-align: center;">
										@GetStateText(appt.State)
									</span>
								</td>
								<td class="py-3">
									<form method="post" asp-action="DescargarComprobante" asp-controller="Doctor">
										<input type="hidden" name="id" value="@appt.IdAppointment" />
										<button type="submit" class="btn btn-sm fw-semibold d-flex align-items-center gap-2 px-3 py-2"
												style="background-color: #e53935; color: white; border-radius: 8px;">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
												<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
												<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
											</svg>
											Descargar PDF
										</button>
									</form>
								</td>
							</tr>
						}
					</tbody>
				</table>

				@if (Model.Appointments.Count == 0)
				{
					<div class="text-center py-5">
						<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#94a3b8" class="mb-3" viewBox="0 0 16 16">
							<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
							<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
						</svg>
						<p class="text-muted fs-5 mb-0">No se encontraron citas para este paciente</p>
					</div>
				}

				<nav class="mt-5 mb-3">
					<ul class="pagination justify-content-center gap-2">
						<li class="page-item">
							<a class="page-link border-0 rounded-3 shadow-sm @(Model.CurrentPage == 1 ? "disabled bg-light text-muted" : "")"
							   asp-action="Profile"
							   asp-route-page="@(Model.CurrentPage - 1)"
							   asp-route-searchPatient="@ViewBag.SearchPatient"
							   style="@(Model.CurrentPage == 1 ? "" : "background: linear-gradient(to right, #2563eb, #06b6d4); color: white;") padding: 10px;">
								<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
									<path d="M15 18l-6-6 6-6" />
								</svg>
							</a>
						</li>

						@for (int i = 1; i <= Model.TotalPages; i++)
						{
							<li class="page-item">
								<a class="page-link border-0 rounded-3 shadow-sm fw-semibold"
								   asp-action="Profile"
								   asp-route-page="@i"
								   asp-route-searchPatient="@ViewBag.SearchPatient"
								   style="@(Model.CurrentPage == i ? "background: linear-gradient(to right, #2563eb, #06b6d4); color: white;" : "background: white; color: #2563eb;") padding: 10px; text-align: center;">
									@i
								</a>
							</li>
						}

						<li class="page-item">
							<a class="page-link border-0 rounded-3 shadow-sm @(Model.CurrentPage == Model.TotalPages ? "disabled bg-light text-muted" : "")"
							   asp-action="Profile"
							   asp-route-page="@(Model.CurrentPage + 1)"
							   asp-route-searchPatient="@ViewBag.SearchPatient"
							   style="@(Model.CurrentPage == Model.TotalPages ? "" : "background: linear-gradient(to right, #2563eb, #06b6d4); color: white;") padding: 10px; ">
								<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
									<path d="M9 18l6-6-6-6" />
								</svg>
							</a>
						</li>
					</ul>
				</nav>
			</div>
		</section>

	</div>
}