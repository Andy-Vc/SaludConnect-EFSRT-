@model Web.Models.ViewModels.PatientWM.BookingDateViewModel

@{
    ViewData["Title"] = "Seleccionar Fecha y Hora";
    Layout = "~/Views/Shared/_LayoutPatient.cshtml";
}


<style>
    .calendar-day {
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

        .calendar-day.available {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }

            .calendar-day.available:hover {
                background-color: #3b82f6;
                color: white;
                transform: scale(1.05);
            }

        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }

        .calendar-day.unavailable {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

    .time-slot {
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

        .time-slot.available:hover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        .time-slot.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .time-slot.occupied {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
            cursor: not-allowed;
        }
</style>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-center">
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="progress-step completed">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="ml-2 text-sm font-medium text-success">Especialidad</span>
                </div>
                <div class="w-16 h-0.5 bg-success"></div>
                <div class="flex items-center">
                    <div class="progress-step completed">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="ml-2 text-sm font-medium text-success">Doctor</span>
                </div>
                <div class="w-16 h-0.5 bg-primary"></div>
                <div class="flex items-center">
                    <div class="progress-step active">
                        <span class="text-sm font-medium">3</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-primary">Fecha</span>
                </div>
                <div class="w-16 h-0.5 bg-secondary-200"></div>
                <div class="flex items-center">
                    <div class="progress-step">
                        <span class="text-sm font-medium text-secondary-400">4</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-secondary-400">Confirmar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Summary -->
    <div class="mb-8">
        <div class="max-w-4xl mx-auto">
            <div class="card">
                <h2 class="text-lg font-semibold text-text-primary mb-4">Resumen de la Cita</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-text-secondary">Especialidad</p>
                            <p class="font-semibold text-text-primary">@Model.DoctorInfo.speciality.NameSpecialty</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-text-secondary">Doctor</p>
                            <p class="font-semibold text-text-primary">@Model.DoctorInfo.fullNameDoc</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar and Time Selection -->
    <div class="max-w-6xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendar Section -->
            <div class="lg:col-span-2">
                <div class="card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-text-primary">Seleccionar Fecha</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousMonth()" class="p-2 text-text-secondary hover:text-primary transition-smooth">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h4 class="text-lg font-medium text-text-primary" id="current-month"></h4>
                            <button onclick="nextMonth()" class="p-2 text-text-secondary hover:text-primary transition-smooth">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Day Headers -->
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Lun</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Mar</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Mié</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Jue</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Vie</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Sáb</div>
                        <div class="text-center text-sm font-medium text-text-secondary py-2">Dom</div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1" id="calendar-grid"></div>

                    <!-- Legend -->
                    <div class="flex items-center justify-center space-x-6 mt-6 pt-6 border-t border-secondary-200">
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 bg-primary rounded"></div>
                            <span class="text-sm text-text-secondary">Seleccionado</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 bg-blue-100 border-2 border-blue-500 rounded"></div>
                            <span class="text-sm text-text-secondary">Disponible</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 bg-gray-200 rounded"></div>
                            <span class="text-sm text-text-secondary">No disponible</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Slots Section -->
            <div class="lg:col-span-1">
                <div class="card">
                    <h3 class="text-xl font-semibold text-text-primary mb-6">Horarios Disponibles</h3>

                    <!-- Selected Date Display -->
                    <div class="mb-6 p-4 bg-primary-50 rounded-lg">
                        <p class="text-sm text-text-secondary">Fecha seleccionada</p>
                        <p class="font-semibold text-primary" id="selected-date-display">Selecciona una fecha</p>
                    </div>

                    <!-- Time Slots Container -->
                    <div id="time-slots-container">
                        <div class="text-center py-8">
                            <svg class="mx-auto h-12 w-12 text-text-secondary mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-text-secondary">Selecciona una fecha para ver horarios</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="max-w-6xl mx-auto mt-8">
        <div class="flex items-center justify-between">
            <button onclick="goBack()" class="btn-secondary px-6 py-3 rounded-lg">
                <svg class="w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Volver
            </button>
            <button id="continue-btn" onclick="proceedToConfirmation()" class="btn-primary px-6 py-3 rounded-lg opacity-50 cursor-not-allowed" disabled>
                Continuar
                <svg class="w-5 h-5 ml-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>
</main>

<script>

    const idDoctor = @Model.IdDoctor;
    const idSpecialty = @Model.IdSpecialty;
    let currentDate = new Date();
    let selectedDate = null;
    let selectedTime = null;
    let availableDatesData = @Html.Raw(Json.Serialize(Model.AvailableDates));

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    document.addEventListener('DOMContentLoaded', function() {
        updateCalendarHeader();
        generateCalendar();
    });

    function updateCalendarHeader() {
        const monthYear = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        document.getElementById('current-month').textContent = monthYear;
    }

    function generateCalendar() {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // Empezar desde el lunes
        const startDate = new Date(firstDay);
        const dayOfWeek = firstDay.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(firstDay.getDate() - daysToSubtract);

        // Generar 42 días (6 semanas)
        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);

            const dayElement = createDayElement(cellDate, month);
            calendarGrid.appendChild(dayElement);
        }
    }

    function createDayElement(date, currentMonth) {
        const dayElement = document.createElement('div');
        const dateStr = formatDateForAPI(date);
        const isCurrentMonth = date.getMonth() === currentMonth;
        const isPast = date < new Date().setHours(0, 0, 0, 0);

        // VERIFICAR SI LA FECHA TIENE DISPONIBILIDAD
        const hasAvailability = availableDatesData.some(d =>
            formatDateForAPI(new Date(d.scheduleDate)) === dateStr && d.availableSlots > 0
        );

        const isSelected = selectedDate && formatDateForAPI(selectedDate) === dateStr;

        dayElement.className = 'calendar-day';
        dayElement.textContent = date.getDate();

        if (!isCurrentMonth) {
            dayElement.classList.add('unavailable');
            dayElement.style.color = '#d1d5db';
        } else if (isPast) {
            dayElement.classList.add('unavailable');
        } else if (isSelected) {
            dayElement.classList.add('selected');
        } else if (hasAvailability) {
            dayElement.classList.add('available');
        } else {
            dayElement.classList.add('unavailable');
        }

        if (isCurrentMonth && !isPast && hasAvailability) {
            dayElement.addEventListener('click', () => selectDate(date));
        }

        return dayElement;
    }

    async function selectDate(date) {
        selectedDate = date;
        selectedTime = null;
        generateCalendar();
        updateSelectedDateDisplay();

        await loadTimeSlots(date);

        updateContinueButton();
    }

    function updateSelectedDateDisplay() {
        const display = document.getElementById('selected-date-display');
        if (selectedDate) {
            display.textContent = formatDateSpanish(selectedDate);
        } else {
            display.textContent = 'Selecciona una fecha';
        }
    }

    async function loadTimeSlots(date) {
        const container = document.getElementById('time-slots-container');
        container.innerHTML = '<div class="text-center py-8"><p class="text-text-secondary">Cargando horarios...</p></div>';

        try {
            const dateStr = formatDateForAPI(date);

            const response = await fetch(`/Patient/GetTimeSlots?idDoctor=${idDoctor}&idSpecialty=${idSpecialty}&date=${dateStr}`);
            const result = await response.json();

            if (result.success && result.data && result.data.length > 0) {
                displayTimeSlots(result.data);
            } else {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-text-secondary mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-text-secondary">No hay horarios disponibles</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error al cargar horarios:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-600"><p>Error al cargar horarios</p></div>';
        }
    }

    function displayTimeSlots(timeSlots) {
        const container = document.getElementById('time-slots-container');

        const morning = timeSlots.filter(t => {
            const hour = parseInt(t.timeSlot.split(':')[0]);
            return hour < 12;
        });

        const afternoon = timeSlots.filter(t => {
            const hour = parseInt(t.timeSlot.split(':')[0]);
            return hour >= 12 && hour < 18;
        });

        const evening = timeSlots.filter(t => {
            const hour = parseInt(t.timeSlot.split(':')[0]);
            return hour >= 18;
        });

        let html = '';

        if (morning.length > 0) {
            html += `
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-text-secondary mb-3">☀️ Mañana</h4>
                    <div class="grid grid-cols-2 gap-2">
                        ${morning.map(slot => createTimeSlotHTML(slot)).join('')}
                    </div>
                </div>
            `;
        }

        if (afternoon.length > 0) {
            html += `
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-text-secondary mb-3">🌤️ Tarde</h4>
                    <div class="grid grid-cols-2 gap-2">
                        ${afternoon.map(slot => createTimeSlotHTML(slot)).join('')}
                    </div>
                </div>
            `;
        }

        if (evening.length > 0) {
            html += `
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-text-secondary mb-3">🌙 Noche</h4>
                    <div class="grid grid-cols-2 gap-2">
                        ${evening.map(slot => createTimeSlotHTML(slot)).join('')}
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;

        // Agregar event listeners
        container.querySelectorAll('.time-slot').forEach(slot => {
            if (slot.dataset.available === 'true') {
                slot.addEventListener('click', () => selectTime(slot.dataset.time));
            }
        });
    }

    function createTimeSlotHTML(slot) {
        const isSelected = selectedTime === slot.timeSlot;
        const cssClass = !slot.isAvailable ? 'occupied' : isSelected ? 'selected' : 'available';

        return `
            <button class="time-slot ${cssClass}"
                    data-time="${slot.timeSlot}"
                    data-available="${slot.isAvailable}"
                    ${!slot.isAvailable ? 'disabled' : ''}>
                ${slot.timeSlot}
            </button>
        `;
    }

    function selectTime(time) {
        selectedTime = time;

        // Actualizar visualmente
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
            if (slot.dataset.time === time) {
                slot.classList.add('selected');
            }
        });

        updateContinueButton();
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarHeader();
        generateCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarHeader();
        generateCalendar();
    }

    function goBack() {
        window.location.href = `/Patient/BookingDoctor?idSpecialty=${idSpecialty}`;
    }

    function proceedToConfirmation() {
        if (selectedDate && selectedTime) {
            const dateStr = formatDateForAPI(selectedDate);
            window.location.href = `/Patient/BookingSuccess?idDoctor=${idDoctor}&idSpecialty=${idSpecialty}&date=${dateStr}&time=${selectedTime}`;
        }
    }

    function updateContinueButton() {
        const continueBtn = document.getElementById('continue-btn');
        if (selectedDate && selectedTime) {
            continueBtn.disabled = false;
            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            continueBtn.disabled = true;
            continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateSpanish(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
</script>