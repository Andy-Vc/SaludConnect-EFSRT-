@using Web.Models.DTO
@using Web.Extensions
@{
    ViewData["Title"] = "Record";
    Layout = "~/Views/Shared/_LayoutPatient.cshtml";

    var recordAppointments = ViewBag.ListAppointments as List<RecordAppointmentsDTO>;

    var user = Context?.Session?.GetObjectFromJson<User>("User");
    var nombreApellido = ($"{user.FirstName} {user.LastNamePat}");
}

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-semibold text-text-primary mb-2">Historial de Citas</h2>
                <p class="text-text-secondary">Revisa todas tus citas médicas anteriores</p>
            </div>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-surface rounded-lg shadow-md p-4 text-center">
            <div class="text-xl font-bold text-text-primary mb-1">@ViewBag.TotalAppointments</div>
            <div class="text-xs text-text-secondary">Total Citas</div>
        </div>
        <div class="bg-surface rounded-lg shadow-md p-4 text-center">
            <div class="text-xl font-bold text-success mb-1">@ViewBag.ApointmentsAssisted</div>
            <div class="text-xs text-text-secondary">Asistidas</div>
        </div>
        <div class="bg-surface rounded-lg shadow-md p-4 text-center">
            <div class="text-xl font-bold text-error mb-1">@ViewBag.ApointmentsCanceled</div>
            <div class="text-xs text-text-secondary">Canceladas</div>
        </div>
        <div class="bg-surface rounded-lg shadow-md p-4 text-center">
            <div class="text-xl font-bold text-warning mb-1">@ViewBag.ApointmentsEarring</div>
            <div class="text-xs text-text-secondary">Inasistencias</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Filters Panel -->
        <div id="filtersPanel" class="lg:col-span-1">
            <div class="bg-surface rounded-lg shadow-md p-6 sticky top-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-text-primary">Filtros</h3>
                    <button class="text-primary text-sm hover:text-primary-700 transition-colors" onclick="clearFilters()">
                        <i class="fas fa-undo mr-1"></i>
                        Limpiar
                    </button>
                </div>

                <!-- Date Range Filter -->
                <div class="mb-6">
                    <label class="form-label">Rango de Fechas</label>
                    <div class="space-y-3">
                        <input type="date" class="form-input" id="dateFrom" value="2024-01-01">
                        <input type="date" class="form-input" id="dateTo" value="2025-12-31">
                    </div>
                </div>

                <!-- Specialty Filter -->
                <div class="mb-6">
                    <label class="form-label">Especialidad</label>
                    <select class="form-input" id="specialtyFilter">
                        <option value="">Todas las especialidades</option>
                        @if (recordAppointments != null)
                        {
                            var specialties = recordAppointments.Select(r => new { r.idSpeciality, r.nameSpeciality }).Distinct();
                            foreach (var spec in specialties)
                            {
                                <option value="@spec.idSpeciality">@spec.nameSpeciality</option>
                            }
                        }
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="mb-6">
                    <label class="form-label">Estado</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2 text-primary status-filter" value="A" checked>
                            <span class="text-sm text-text-primary">Asistido</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2 text-primary status-filter" value="X" checked>
                            <span class="text-sm text-text-primary">Cancelado</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2 text-primary status-filter" value="N" checked>
                            <span class="text-sm text-text-primary">Inasistencia</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2 text-primary status-filter" value="P" checked>
                            <span class="text-sm text-text-primary">Pendiente</span>
                        </label>
                    </div>
                </div>

                <!-- Doctor Search -->
                <div class="mb-6">
                    <label class="form-label">Buscar Doctor</label>
                    <div class="relative">
                        <input type="text" class="form-input pl-10" placeholder="Nombre del doctor..." id="doctorSearch">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-secondary-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Results Count -->
                <div class="text-center pt-4 border-t border-secondary-200">
                    <p class="text-sm text-text-secondary">
                        <span id="resultsCount">0</span> citas encontradas
                    </p>
                </div>
            </div>
        </div>

        <!-- Appointments Timeline -->
        <div class="lg:col-span-3">
            <div id="appointmentsList" class="space-y-6">
                @if (recordAppointments != null && recordAppointments.Count > 0)
                {
                    var appointmentsByMonth = recordAppointments
                    .GroupBy(r =>
                    {
                        var parts = r.fechaCita.Split('/');
                        return new { Month = int.Parse(parts[1]), Year = int.Parse(parts[2]) };
                    })
                    .OrderByDescending(g => g.Key.Year)
                    .ThenByDescending(g => g.Key.Month);

                    foreach (var monthGroup in appointmentsByMonth)
                    {
                        var monthName = new DateTime(monthGroup.Key.Year, monthGroup.Key.Month, 1).ToString("MMMM yyyy", new System.Globalization.CultureInfo("es-ES"));

                        <!-- Timeline Month Separator -->
                        <div class="flex items-center month-separator">
                            <div class="flex-1 border-t border-secondary-200"></div>
                            <div class="px-4 text-sm font-medium text-text-secondary bg-background capitalize">@monthName</div>
                            <div class="flex-1 border-t border-secondary-200"></div>
                        </div>

                        @foreach (var record in monthGroup.OrderByDescending(r => r.fechaCita))
                        {
                            var estadoString = record.state switch
                            {
                                "A" => "Asistido",
                                "X" => "Cancelado",
                                "P" => "Pendiente",
                                "N" => "No asistió",
                                _ => "Error estado"
                            };

                            var abreviaturaMedico = record.gender == "M" ? "Dr." : "Dra.";
                            var uniqueId = $"appointment{record.idAppointment}";

                            var parts = record.fechaCita.Split('/');
                            var dateForFilter = $"{parts[2]}-{parts[1].PadLeft(2, '0')}-{parts[0].PadLeft(2, '0')}";

                            <div class="medical-card cursor-pointer appointment-card"
                                 data-status="@record.state"
                                 data-specialty="@record.idSpeciality"
                                 data-date="@dateForFilter"
                                 data-doctor="@record.nombresDoctor"
                                 onclick="toggleAppointmentDetails('@uniqueId')">
                                <div class="flex items-start space-x-4">
                                    <img src="@(string.IsNullOrEmpty(record.profilePicture) ? "https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=150" : record.profilePicture)"
                                         alt="@abreviaturaMedico @record.nombresDoctor"
                                         class="w-12 h-12 rounded-full object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="text-sm font-medium text-text-primary">@record.nameSpeciality - @record.nameService</h4>
                                            <span class="status-@(record.state == "A" ? "success" : record.state == "X" ? "error" : "warning")">@estadoString</span>
                                        </div>
                                        <p class="text-sm text-text-secondary mb-1">@abreviaturaMedico @record.nombresDoctor</p>
                                        <div class="flex items-center text-xs text-text-secondary mb-2">
                                            <i class="far fa-calendar-alt mr-1"></i>
                                            <span>@record.fechaCita</span>
                                            <i class="far fa-clock ml-3 mr-1"></i>
                                            <span>@record.horaCita</span>
                                            <i class="fas fa-map-marker-alt ml-3 mr-1"></i>
                                            <span>Consultorio @record.consultorio</span>
                                        </div>
                                        <p class="text-xs text-text-secondary">@record.descripcion</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-chevron-down text-secondary-400 transition-transform" id="chevron-@uniqueId"></i>
                                    </div>
                                </div>

                                <!-- Expandable Details -->
                                <div id="details-@uniqueId" class="hidden mt-4 pt-4 border-t border-secondary-200">
                                    @switch (record.state)
                                    {
                                        case "A":
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <h5 class="font-medium text-text-primary mb-2">Diagnóstico</h5>
                                                    <p class="text-sm text-text-secondary">@record.diagnosis</p>
                                                </div>
                                                <div>
                                                    <h5 class="font-medium text-text-primary mb-2">Tratamiento</h5>
                                                    <p class="text-sm text-text-secondary">@record.treatment</p>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <h5 class="font-medium text-text-primary mb-2">Observaciones</h5>
                                                    <p class="text-sm text-text-secondary">@record.observations</p>
                                                </div>
                                            </div>
                                            <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                                <div class="text-sm text-text-secondary">
                                                    <strong>Costo:</strong> MXN @record.appointmentPrice?.ToString("N2")
                                                </div>
                                                <!-- NUEVO: Botones de descarga PDF -->
                                                <div class="flex flex-wrap" style="gap: 1rem;">
                                                    <!-- Descargar PDF de Cita -->
                                                    <form method="post" asp-action="DownloadPDFAppointment" asp-controller="Doctor" class="m-0" onclick="event.stopPropagation()">
                                                        <input type="hidden" name="id" value="@record.idAppointment" />
                                                        <button type="submit"
                                                                class="inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-danger"
                                                                title="Descargar Cita PDF">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                                            </svg>
                                                            Cita
                                                        </button>
                                                    </form>

                                                    <!-- Descargar PDF de Historia Médica (solo si existe) -->
                                                    @if (!string.IsNullOrEmpty(record.diagnosis) || !string.IsNullOrEmpty(record.treatment))
                                                    {
                                                        <form method="post" asp-action="DownloadPDFMedicalRecord" asp-controller="Doctor" class="m-0" onclick="event.stopPropagation()">
                                                            <input type="hidden" name="id" value="@record.idAppointment" />
                                                            <button type="submit"
                                                                    class="inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-primary"
                                                                    title="Descargar Registro Médico PDF">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                                                </svg>
                                                                Historia
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                            break;

                                        case "P":
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                <div class="flex items-center mb-2">
                                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                                    <h5 class="font-medium text-blue-600">Cita Pendiente</h5>
                                                </div>
                                                <p class="text-sm text-text-secondary mb-2">
                                                    Tu cita está programada. Recuerda llegar 30 minutos antes.
                                                </p>
                                                <p class="text-sm text-text-secondary">
                                                    <strong>Duración estimada:</strong> @record.duracionMinutes minutos
                                                </p>
                                            </div>
                                            <!-- NUEVO: Botón de descarga PDF solo para cita -->
                                            <div class="mt-4 flex items-center justify-end">
                                                <form method="post" asp-action="DownloadPDFAppointment" asp-controller="Doctor" class="m-0" onclick="event.stopPropagation()">
                                                    <input type="hidden" name="id" value="@record.idAppointment" />
                                                    <button type="submit"
                                                            class="inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-danger"
                                                            title="Descargar Cita PDF">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                                        </svg>
                                                        Descargar Cita
                                                    </button>
                                                </form>
                                            </div>
                                            break;

                                        case "X":
                                            <div class="bg-error-50 border border-error-200 rounded-lg p-4">
                                                <div class="flex items-center mb-2">
                                                    <i class="fas fa-info-circle text-error mr-2"></i>
                                                    <h5 class="font-medium text-error">Cita Cancelada</h5>
                                                </div>
                                                <p class="text-sm text-text-secondary">
                                                    Esta cita fue cancelada. Puedes reagendar cuando lo necesites.
                                                </p>
                                            </div>
                                            <div class="mt-4 flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-2">
                                                <!-- Descargar PDF de Cita -->
                                                <form method="post" asp-action="DownloadPDFAppointment" asp-controller="Doctor" class="m-0" onclick="event.stopPropagation()">
                                                    <input type="hidden" name="id" value="@record.idAppointment" />
                                                    <button type="submit"
                                                            class="inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-danger"
                                                            title="Descargar Cita PDF">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                                        </svg>
                                                        Descargar Cita
                                                    </button>
                                                </form>
                                                <a asp-controller="Patient" asp-action="Booking" class="btn-primary text-sm inline-flex items-center justify-center">
                                                    <i class="fas fa-plus mr-1"></i>
                                                    Reagendar Cita
                                                </a>
                                            </div>
                                            break;

                                        case "N":
                                            <div class="bg-warning-50 border border-warning-200 rounded-lg p-4">
                                                <div class="flex items-center mb-2">
                                                    <i class="fas fa-exclamation-triangle text-warning mr-2"></i>
                                                    <h5 class="font-medium text-warning">Inasistencia Registrada</h5>
                                                </div>
                                                <p class="text-sm text-text-secondary mb-2">
                                                    No se registró asistencia a esta cita.
                                                </p>
                                                <p class="text-sm text-text-secondary">
                                                    Se recomienda reagendar para continuar con el seguimiento médico.
                                                </p>
                                            </div>
                                            <div class="mt-4 flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-2">
                                                <!-- Descargar PDF de Cita -->
                                                <form method="post" asp-action="DownloadPDFAppointment" asp-controller="Patient" class="m-0" onclick="event.stopPropagation()">
                                                    <input type="hidden" name="id" value="@record.idAppointment" />
                                                    <button type="submit"
                                                            class="inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold text-white bg-danger"
                                                            title="Descargar Cita PDF">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                                        </svg>
                                                        Descargar Cita
                                                    </button>
                                                </form>
                                                <a asp-controller="Patient" asp-action="Booking" class="btn-primary text-sm inline-flex items-center justify-center">
                                                    <i class="fas fa-plus mr-1"></i>
                                                    Reagendar Cita
                                                </a>
                                            </div>
                                            break;
                                    }
                                </div>
                            </div>
                        }
                    }
                }
                else
                {
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-calendar-alt text-6xl text-secondary-300"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-text-primary mb-2">¡Hola @nombreApellido!</h3>
                        <p class="text-text-secondary mb-6">
                            No tienes historial de citas. ¿Deseas agendar una nueva cita?
                        </p>
                        <a asp-controller="Patient" asp-action="Booking" class="btn-primary inline-block">
                            <i class="fas fa-plus mr-2"></i>
                            Programar Nueva Cita
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</main>
<!-- Mobile Filters Overlay -->
<div id="mobileFiltersOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 md:hidden">
    <div class="fixed inset-y-0 right-0 w-80 bg-surface shadow-lg transform transition-transform duration-300" id="mobileFiltersPanel">
        <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-text-primary">Filtros</h3>
                    <button class="text-text-secondary hover:text-text-primary" onclick="toggleFilters()">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="space-y-6">
                    <!-- Date Range Filter -->
                    <div>
                        <label class="form-label">Rango de Fechas</label>
                        <div class="space-y-3">
                            <input type="date" class="form-input" value="2024-01-01">
                            <input type="date" class="form-input" value="2025-10-11">
                        </div>
                    </div>

                    <!-- Specialty Filter -->
                    <div>
                        <label class="form-label">Especialidad</label>
                        <select class="form-input">
                            <option value="">Todas las especialidades</option>
                            <option value="cardiologia">Cardiología</option>
                            <option value="dermatologia">Dermatología</option>
                            <option value="neurologia">Neurología</option>
                            <option value="pediatria">Pediatría</option>
                            <option value="traumatologia">Traumatología</option>
                            <option value="ginecologia">Ginecología</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="form-label">Estado</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2 text-primary" value="asistido" checked>
                                <span class="text-sm text-text-primary">Asistido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2 text-primary" value="cancelado" checked>
                                <span class="text-sm text-text-primary">Cancelado</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2 text-primary" value="inasistencia" checked>
                                <span class="text-sm text-text-primary">Inasistencia</span>
                            </label>
                        </div>
                    </div>

                    <!-- Doctor Search -->
                    <div>
                        <label class="form-label">Buscar Doctor</label>
                        <div class="relative">
                            <input type="text" class="form-input pl-10" placeholder="Nombre del doctor...">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-secondary-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex space-x-3">
                    <button class="btn-secondary flex-1" onclick="clearFilters()">
                        Limpiar
                    </button>
                    <button class="btn-primary flex-1" onclick="applyFilters()">
                        Aplicar
                    </button>
                </div>
        </div>
    </div>
</div>

<!-- Floating Help Button -->
<button class="fab" onclick="window.location.href='help_center.html'" title="Centro de Ayuda">
    <i class="fas fa-question text-lg"></i>
</button>


<script>
    function toggleFilters() {
        const overlay = document.getElementById('mobileFiltersOverlay');
        const panel = document.getElementById('mobileFiltersPanel');

        if (overlay && panel) {
            overlay.classList.toggle('hidden');

            if (!overlay.classList.contains('hidden')) {
                setTimeout(() => {
                    panel.classList.remove('translate-x-full');
                }, 10);
            } else {
                panel.classList.add('translate-x-full');
            }
        }
    }

    function toggleAppointmentDetails(appointmentId) {
        const details = document.getElementById(`details-${appointmentId}`);
        const chevron = document.getElementById(`chevron-${appointmentId}`);

        if (details && chevron) {
            details.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }
    }

    function clearFilters() {
        // Desktop filters
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const specialtyFilter = document.getElementById('specialtyFilter');
        const doctorSearch = document.getElementById('doctorSearch');

        if (dateFrom) dateFrom.value = '2024-01-01';
        if (dateTo) dateTo.value = '2025-12-31';
        if (specialtyFilter) specialtyFilter.value = '';
        if (doctorSearch) doctorSearch.value = '';

        // Reset all checkboxes
        document.querySelectorAll('.status-filter').forEach(checkbox => {
            checkbox.checked = true;
        });

        applyFilters();
    }

    function applyFilters() {
        // Get filter values
        const dateFrom = document.getElementById('dateFrom')?.value || '2024-01-01';
        const dateTo = document.getElementById('dateTo')?.value || '2025-12-31';
        const specialty = document.getElementById('specialtyFilter')?.value || '';
        const doctorSearch = (document.getElementById('doctorSearch')?.value || '').toLowerCase();

        // Get checked statuses
        const checkedStatuses = new Set();
        document.querySelectorAll('.status-filter:checked').forEach(checkbox => {
            checkedStatuses.add(checkbox.value);
        });

        // Filter appointment cards
        const cards = document.querySelectorAll('.appointment-card');
        let visibleCount = 0;
        const visibleMonths = new Set();

        cards.forEach(card => {
            const cardStatus = card.dataset.status;
            const cardSpecialty = card.dataset.specialty;
            const cardDate = card.dataset.date;
            const doctorName = (card.dataset.doctor || '').toLowerCase();

            let shouldShow = true;

            // Check status filter
            if (!checkedStatuses.has(cardStatus)) {
                shouldShow = false;
            }

            // Check specialty filter
            if (specialty && cardSpecialty !== specialty) {
                shouldShow = false;
            }

            // Check date range
            if (dateFrom && cardDate < dateFrom) {
                shouldShow = false;
            }
            if (dateTo && cardDate > dateTo) {
                shouldShow = false;
            }

            // Check doctor search
            if (doctorSearch && !doctorName.includes(doctorSearch)) {
                shouldShow = false;
            }

            if (shouldShow) {
                card.style.display = 'block';
                visibleCount++;

                // Track visible month - buscar el separador anterior más cercano
                let prevElement = card.previousElementSibling;
                while (prevElement) {
                    if (prevElement.classList.contains('month-separator')) {
                        visibleMonths.add(prevElement);
                        break;
                    }
                    prevElement = prevElement.previousElementSibling;
                }
            } else {
                card.style.display = 'none';
            }
        });

        // Show/hide month separators
        document.querySelectorAll('.month-separator').forEach(separator => {
            if (visibleMonths.has(separator)) {
                separator.style.display = 'flex';
            } else {
                separator.style.display = 'none';
            }
        });

        // Update results count
        const resultsCount = document.getElementById('resultsCount');
        if (resultsCount) {
            resultsCount.textContent = visibleCount;
        }

        // Close mobile filters after applying
        const overlay = document.getElementById('mobileFiltersOverlay');
        if (overlay && !overlay.classList.contains('hidden')) {
            toggleFilters();
        }
    }

    function showToast(message, type = 'success') {
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500'
        };

        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Close mobile filters when clicking overlay
    const mobileOverlay = document.getElementById('mobileFiltersOverlay');
    if (mobileOverlay) {
        mobileOverlay.addEventListener('click', function(event) {
            if (event.target === this) {
                toggleFilters();
            }
        });
    }

    // Real-time filter updates
    document.addEventListener('DOMContentLoaded', function() {
        // Setup event listeners
        const doctorSearch = document.getElementById('doctorSearch');
        const specialtyFilter = document.getElementById('specialtyFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');

        if (doctorSearch) {
            doctorSearch.addEventListener('input', applyFilters);
        }

        if (specialtyFilter) {
            specialtyFilter.addEventListener('change', applyFilters);
        }

        if (dateFrom) {
            dateFrom.addEventListener('change', applyFilters);
        }

        if (dateTo) {
            dateTo.addEventListener('change', applyFilters);
        }

        // Status checkboxes
        document.querySelectorAll('.status-filter').forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });

        // Initialize filters
        applyFilters();
    });
</script>