@model List<Web.Models.ViewModels.PatientVM.SpecialtyViewModel>

@using Web.Models
@{
    ViewData["Title"] = "Seleccionar Especialidad";
    Layout = "~/Views/Shared/_LayoutPatient.cshtml";
}

<style>
    .progress-step {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e5e7eb;
        transition: all 0.3s;
    }

        .progress-step.active {
            background-color: var(--primary-color);
            color: white;
        }

    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }

    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        border: 2px solid transparent;
    }

        .card.selected {
            border-color: var(--primary-color, #3b82f6);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

    /* --- ESTILOS DINÁMICOS DE ICONOS --- */
    .bg-cardio {
        background-color: #fee2e2;
    }

    .text-cardio {
        color: #dc2626;
    }

    .bg-pediatria {
        background-color: #e0f2fe;
    }

    .text-pediatria {
        color: #0284c7;
    }

    .bg-derm {
        background-color: #f0fdf4;
    }

    .text-derm {
        color: #16a34a;
    }

    .bg-interna {
        background-color: #f3e8ff;
    }

    .text-interna {
        color: #9333ea;
    }

    .bg-neuro {
        background-color: #fefce8;
    }

    .text-neuro {
        color: #ca8a04;
    }

    .bg-oftal {
        background-color: #eef2ff;
    }

    .text-oftal {
        color: #4f46e5;
    }

    .bg-orto {
        background-color: #fff7ed;
    }

    .text-orto {
        color: #ea580c;
    }

    .bg-psic {
        background-color: #fdf2f8;
    }

    .text-psic {
        color: #db2777;
    }

    .bg-default {
        background-color: #eff6ff;
    }

    .text-default {
        color: #2563eb;
    }

    .input-focus {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.3s;
    }

        .input-focus:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    .active-scale:active {
        transform: scale(0.95);
    }

    .transition-smooth {
        transition: all 0.3s ease;
    }

    .shadow-floating {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
</style>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb Navigation -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <div>
                    <a asp-controller="Patient" asp-action="Index" class="text-text-secondary hover:text-primary transition-smooth">
                        <svg class="flex-shrink-0 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                        </svg>
                        <span class="sr-only">Inicio</span>
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-text-secondary" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="ml-4 text-sm font-medium text-primary">Reservar Cita</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-center">
            <div class="flex items-center space-x-4">
                <!-- Step 1: Specialty Selection (Active) -->
                <div class="flex items-center">
                    <div class="progress-step active">
                        <span class="text-sm font-medium">1</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-primary">Especialidad</span>
                </div>

                <!-- Connector -->
                <div class="w-16 h-0.5 bg-secondary-200"></div>

                <!-- Step 2: Doctor Selection -->
                <div class="flex items-center">
                    <div class="progress-step">
                        <span class="text-sm font-medium text-secondary-400">2</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-secondary-400">Doctor</span>
                </div>

                <!-- Connector -->
                <div class="w-16 h-0.5 bg-secondary-200"></div>

                <!-- Step 3: Calendar -->
                <div class="flex items-center">
                    <div class="progress-step">
                        <span class="text-sm font-medium text-secondary-400">3</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-secondary-400">Fecha</span>
                </div>

                <!-- Connector -->
                <div class="w-16 h-0.5 bg-secondary-200"></div>

                <!-- Step 4: Confirmation -->
                <div class="flex items-center">
                    <div class="progress-step">
                        <span class="text-sm font-medium text-secondary-400">4</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-secondary-400">Confirmar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-semibold text-text-primary mb-2">Seleccionar Especialidad Médica</h1>
        <p class="text-text-secondary max-w-2xl mx-auto">
            Elige la especialidad médica que necesitas para tu consulta. Nuestros especialistas están disponibles para brindarte la mejor atención.
        </p>
    </div>

    <!-- Search and Filter Section -->
    <div class="mb-8">
        <div class="max-w-2xl mx-auto">
            <!-- Search Bar -->
            <div class="relative mb-6">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text"
                       id="specialty-search"
                       class="input-focus w-full pl-10 pr-4"
                       placeholder="Buscar especialidad médica...">
            </div>
        </div>
    </div>

    <!-- Specialties Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="specialties-grid">
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
        @* ... (código SVG y texto) ... *@
    </div>
</main>

@section Scripts {
    <script>
        const specialtiesGrid = document.getElementById('specialties-grid');
        const searchInput = document.getElementById('specialty-search');
        const noResults = document.getElementById('no-results');

        let isNavigating = false;
        let specialtyCards = []; // Lista para las tarjetas cargadas dinámicamente

        async function loadSpecialties() {
            try {
                specialtiesGrid.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full" role="status"></div><p class="mt-2 text-sm text-text-primary">Cargando especialidades...</p></div>';

                const response = await fetch('@Url.Action("GetSpecialtiesPartial", "Patient")', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Opcional pero buena práctica
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const htmlContent = await response.text();
                specialtiesGrid.innerHTML = htmlContent;

                // Actualiza la lista de tarjetas después de la carga
                specialtyCards = document.querySelectorAll('.specialty-card');

                // Vuelve a adjuntar los event listeners después de cargar el nuevo HTML
                attachCardEventListeners();

                // Inicializa la lógica de búsqueda con el contenido cargado
                filterSpecialties(searchInput.value.toLowerCase());

            } catch (error) {
                console.error('Error al cargar las especialidades:', error);
                specialtiesGrid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-500">Error al cargar las especialidades. Intente recargar la página.</p></div>';
            }
        }

        function attachCardEventListeners() {
            specialtyCards.forEach(card => {
                card.removeEventListener('click', handleCardClick); // Evita duplicados
                card.addEventListener('click', handleCardClick);

                card.removeEventListener('mouseenter', handleCardMouseEnter);
                card.removeEventListener('mouseleave', handleCardMouseLeave);
                card.addEventListener('mouseenter', handleCardMouseEnter);
                card.addEventListener('mouseleave', handleCardMouseLeave);
            });
        }

        function handleCardClick() {
            if (isNavigating) return;

            const idSpecialty = this.dataset.id;

            if (!idSpecialty || idSpecialty === '0') {
                console.error('ID de especialidad inválido:', idSpecialty);
                alert('Error: No se pudo obtener la especialidad. Por favor, intente nuevamente.');
                return;
            }

            isNavigating = true;

            specialtyCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');

            setTimeout(() => {
                window.location.href = `/Patient/BookingDoctor?idSpecialty=${idSpecialty}`;
            }, 200);
        }

        function handleCardMouseEnter() {
            if (!isNavigating) { this.style.transform = 'translateY(-4px)'; }
        }

        function handleCardMouseLeave() {
            if (!isNavigating) { this.style.transform = 'translateY(0)'; }
        }


        function filterSpecialties(searchTerm) {
            let visibleCount = 0;
            const searchTermLower = searchTerm.toLowerCase();

            specialtyCards.forEach(card => {
                const specialtyName = card.querySelector('h3').textContent.toLowerCase();
                const specialtyDescription = card.querySelector('p').textContent.toLowerCase();

                const matchesSearch = specialtyName.includes(searchTermLower) || specialtyDescription.includes(searchTermLower);

                if (matchesSearch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            noResults.classList.toggle('hidden', visibleCount > 0);
        }

        searchInput.addEventListener('input', function() {
            filterSpecialties(this.value);
        });

        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filterSpecialties('');
                this.blur();
            }
        });

        document.addEventListener('DOMContentLoaded', loadSpecialties);

    </script>
}


