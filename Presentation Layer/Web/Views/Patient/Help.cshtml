
@{
    ViewData["Title"] = "Help";
    Layout = "~/Views/Shared/_LayoutPatient.cshtml";
}


<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <div class="bg-primary-50 rounded-full w-12 h-12 flex items-center justify-center mr-4">
                <i class="fas fa-question-circle text-primary text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-semibold text-text-primary">Centro de Ayuda</h2>
                <p class="text-text-secondary">Encuentra respuestas rápidas a tus preguntas más frecuentes</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Chat Interface -->
        <div class="lg:col-span-2">
            <div class="bg-surface rounded-lg shadow-md h-96 lg:h-128 flex flex-col">
                <!-- Chat Header -->
                <div class="p-4 border-b border-secondary-200 bg-primary-50 rounded-t-lg">
                    <div class="flex items-center">
                        <div class="bg-primary rounded-full w-10 h-10 flex items-center justify-center mr-3">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-text-primary">Asistente Virtual MediCitas</h3>
                            <p class="text-sm text-text-secondary flex items-center">
                                <span class="w-2 h-2 bg-success rounded-full mr-2"></span>
                                En línea - Respuesta inmediata
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="bg-primary rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-primary-50 rounded-lg p-3 max-w-xs">
                            <p class="text-sm text-text-primary">¡Hola! Soy tu asistente virtual de MediCitas. ¿En qué puedo ayudarte hoy?</p>
                            <span class="text-xs text-text-secondary mt-1 block">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>

                    <!-- Sample conversation -->
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="bg-primary rounded-lg p-3 max-w-xs text-white">
                            <p class="text-sm">¿Cómo puedo programar una cita?</p>
                            <span class="text-xs opacity-75 mt-1 block">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <img class="w-8 h-8 rounded-full object-cover flex-shrink-0" src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Usuario" onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                    </div>

                    <div class="flex items-start space-x-3">
                        <div class="bg-primary rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-secondary-100 rounded-lg p-3 max-w-md">
                            <p class="text-sm text-text-primary mb-2">Para programar una nueva cita, sigue estos pasos:</p>
                            <ol class="text-sm text-text-primary list-decimal list-inside space-y-1">
                                <li>Ve al Panel Principal</li>
                                <li>Haz clic en "Programar Nueva Cita"</li>
                                <li>Selecciona la especialidad médica</li>
                                <li>Elige tu médico preferido</li>
                                <li>Selecciona fecha y hora disponible</li>
                                <li>Confirma tu cita</li>
                            </ol>
                            <div class="flex items-center mt-3 space-x-2">
                                <button class="text-xs text-primary hover:text-primary-700 transition-colors" onclick="provideFeedback('helpful')">
                                    <i class="fas fa-thumbs-up mr-1"></i>Útil
                                </button>
                                <button class="text-xs text-text-secondary hover:text-text-primary transition-colors" onclick="provideFeedback('not-helpful')">
                                    <i class="fas fa-thumbs-down mr-1"></i>No útil
                                </button>
                            </div>
                            <span class="text-xs text-text-secondary mt-2 block">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>

                    <!-- Typing indicator (hidden by default) -->
                    <div id="typingIndicator" class="flex items-start space-x-3 hidden">
                        <div class="bg-primary rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-secondary-100 rounded-lg p-3">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-secondary-400 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-secondary-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                                <div class="w-2 h-2 bg-secondary-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t border-secondary-200">
                    <div class="flex space-x-3">
                        <input type="text" id="chatInput" placeholder="Escribe tu pregunta aquí..." class="form-input flex-1" onkeypress="handleChatInput(event)">
                        <button class="btn-primary px-4" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Help Sidebar -->
        <div class="space-y-6">
            <!-- Predefined Questions -->
            <div class="bg-surface rounded-lg shadow-md p-6">
                <h3 class="text-lg font-medium text-text-primary mb-4">Preguntas Frecuentes</h3>
                <div class="space-y-3">
                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Cómo programar una cita?')">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-plus text-primary mr-3"></i>
                            <span class="text-sm text-text-primary">¿Cómo programar una cita?</span>
                        </div>
                    </button>

                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Cómo cancelar mi cita?')">
                        <div class="flex items-center">
                            <i class="fas fa-times-circle text-error mr-3"></i>
                            <span class="text-sm text-text-primary">¿Cómo cancelar mi cita?</span>
                        </div>
                    </button>

                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Cómo cambiar mi información personal?')">
                        <div class="flex items-center">
                            <i class="fas fa-user-edit text-accent mr-3"></i>
                            <span class="text-sm text-text-primary">¿Cómo cambiar mi información personal?</span>
                        </div>
                    </button>

                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Qué hacer si olvido mi contraseña?')">
                        <div class="flex items-center">
                            <i class="fas fa-key text-warning mr-3"></i>
                            <span class="text-sm text-text-primary">¿Qué hacer si olvido mi contraseña?</span>
                        </div>
                    </button>

                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Cómo reprogramar una cita?')">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt text-primary mr-3"></i>
                            <span class="text-sm text-text-primary">¿Cómo reprogramar una cita?</span>
                        </div>
                    </button>

                    <button class="w-full text-left p-3 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors" onclick="askPredefinedQuestion('¿Cómo ver mi historial de citas?')">
                        <div class="flex items-center">
                            <i class="fas fa-history text-secondary mr-3"></i>
                            <span class="text-sm text-text-primary">¿Cómo ver mi historial de citas?</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- FAQ Categories -->
            <div class="bg-surface rounded-lg shadow-md p-6">
                <h3 class="text-lg font-medium text-text-primary mb-4">Categorías de Ayuda</h3>
                <div class="space-y-2">
                    <button class="w-full text-left p-2 hover:bg-secondary-50 rounded transition-colors" onclick="filterByCategory('appointments')">
                        <span class="text-sm text-text-primary">📅 Gestión de Citas</span>
                    </button>
                    <button class="w-full text-left p-2 hover:bg-secondary-50 rounded transition-colors" onclick="filterByCategory('account')">
                        <span class="text-sm text-text-primary">👤 Cuenta y Perfil</span>
                    </button>
                    <button class="w-full text-left p-2 hover:bg-secondary-50 rounded transition-colors" onclick="filterByCategory('technical')">
                        <span class="text-sm text-text-primary">⚙️ Soporte Técnico</span>
                    </button>
                    <button class="w-full text-left p-2 hover:bg-secondary-50 rounded transition-colors" onclick="filterByCategory('billing')">
                        <span class="text-sm text-text-primary">💳 Facturación</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Floating Chat Widget (minimized state) -->
<div id="floatingChat" class="fixed bottom-6 right-6 hidden">
    <button class="fab bg-primary text-white shadow-floating" onclick="toggleFloatingChat()" title="Ayuda Rápida">
        <i class="fas fa-comments text-lg"></i>
    </button>
</div>

                        @section Scripts {
    <script>
            // Chat functionality
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const typingIndicator = document.getElementById('typingIndicator');

            // Predefined responses database
            const responses = {
                'programar': {
                    keywords: ['programar', 'agendar', 'reservar', 'nueva cita', 'cita'],
                    response: `Para programar una nueva cita, sigue estos pasos:
        1. Ve al Panel Principal
        2. Haz clic en "Programar Nueva Cita"
        3. Selecciona la especialidad médica
        4. Elige tu médico preferido
        5. Selecciona fecha y hora disponible
        6. Confirma tu cita

        ¿Necesitas ayuda con algún paso específico?`
                },
                'cancelar': {
                    keywords: ['cancelar', 'eliminar', 'borrar cita'],
                    response: `Para cancelar una cita:
        1. Ve a "Mis Citas"
        2. Encuentra la cita que deseas cancelar
        3. Haz clic en "Cancelar Cita"
        4. Confirma la cancelación

        Nota: Las cancelaciones deben hacerse con al menos 24 horas de anticipación.`
                },
                'reprogramar': {
                    keywords: ['reprogramar', 'cambiar fecha', 'mover cita', 'cambiar hora'],
                    response: `Para reprogramar una cita:
        1. Ve a "Mis Citas"
        2. Selecciona la cita que deseas reprogramar
        3. Haz clic en "Reprogramar"
        4. Elige una nueva fecha y hora
        5. Confirma los cambios

        ¿Te gustaría reprogramar alguna cita ahora?`
                },
                'perfil': {
                    keywords: ['perfil', 'información personal', 'datos personales', 'actualizar información'],
                    response: `Para actualizar tu información personal:
        1. Ve a "Mi Perfil" en el menú superior
        2. Haz clic en "Editar Perfil"
        3. Modifica los datos que necesites
        4. Guarda los cambios

        Puedes actualizar: nombre, teléfono, dirección, correo electrónico y más.`
                },
                'contraseña': {
                    keywords: ['contraseña', 'password', 'olvidé', 'cambiar contraseña'],
                    response: `Si olvidaste tu contraseña:
        1. Ve a la página de inicio de sesión
        2. Haz clic en "¿Olvidaste tu contraseña?"
        3. Ingresa tu correo electrónico
        4. Revisa tu correo para el enlace de restablecimiento
        5. Crea una nueva contraseña

        El enlace es válido por 24 horas.`
                },
                'historial': {
                    keywords: ['historial', 'citas anteriores', 'ver citas', 'mis citas'],
                    response: `Para ver tu historial de citas:
        1. Ve a "Mis Citas" en el menú
        2. Selecciona la pestaña "Historial"
        3. Podrás ver todas tus citas anteriores con detalles

        También puedes filtrar por fecha, doctor o especialidad.`
                }
            };

            // Handle chat input
            function handleChatInput(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            }

            // Send message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add user message
                addUserMessage(message);
                chatInput.value = '';

                // Show typing indicator
                typingIndicator.classList.remove('hidden');
                scrollToBottom();

                // Simulate processing delay
                setTimeout(() => {
                    typingIndicator.classList.add('hidden');
                    const response = generateResponse(message);
                    addBotMessage(response);
                }, 1000 + Math.random() * 1000);
            }

            // Add user message to chat
            function addUserMessage(message) {
                const timestamp = new Date().toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const messageHTML = `
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="bg-primary rounded-lg p-3 max-w-xs text-white">
                            <p class="text-sm">${escapeHtml(message)}</p>
                            <span class="text-xs opacity-75 mt-1 block">${timestamp}</span>
                        </div>
                        <img class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                             src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3"
                             alt="Usuario">
                    </div>
                `;

                chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                scrollToBottom();
            }

            // Add bot message to chat
            function addBotMessage(message) {
                const timestamp = new Date().toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const messageHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="bg-primary rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-secondary-100 rounded-lg p-3 max-w-md">
                            <p class="text-sm text-text-primary whitespace-pre-line">${escapeHtml(message)}</p>
                            <div class="flex items-center mt-3 space-x-2">
                                <button class="text-xs text-primary hover:text-primary-700 transition-colors" onclick="provideFeedback('helpful')">
                                    <i class="fas fa-thumbs-up mr-1"></i>Útil
                                </button>
                                <button class="text-xs text-text-secondary hover:text-text-primary transition-colors" onclick="provideFeedback('not-helpful')">
                                    <i class="fas fa-thumbs-down mr-1"></i>No útil
                                </button>
                            </div>
                            <span class="text-xs text-text-secondary mt-2 block">${timestamp}</span>
                        </div>
                    </div>
                `;

                chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                scrollToBottom();
            }

            // Generate response based on keywords - VERSIÓN MEJORADA
            function generateResponse(message) {
                const messageLower = message.toLowerCase().trim();

                // Si el mensaje es muy corto (1-3 caracteres), no buscar coincidencias
                if (messageLower.length <= 3) {
                    return `No entiendo tu pregunta. ¿Podrías ser más específico?

        Algunas preguntas que puedo responder:
        - ¿Cómo programar una cita?
        - ¿Cómo cancelar mi cita?
        - ¿Cómo cambiar mi información personal?
        - ¿Qué hacer si olvido mi contraseña?

        ¿En qué puedo ayudarte?`;
                }

                // Buscar coincidencia exacta primero (palabras completas)
                for (const [key, data] of Object.entries(responses)) {
                    for (const keyword of data.keywords) {
                        const regex = new RegExp(`\\b${keyword.toLowerCase()}\\b`, 'i');
                        if (regex.test(messageLower)) {
                            return data.response;
                        }
                    }
                }

                // Si no hay coincidencia exacta, buscar la mejor coincidencia parcial
                let bestMatch = null;
                let maxMatches = 0;

                for (const [key, data] of Object.entries(responses)) {
                    let matchCount = 0;

                    // Contar cuántas keywords coinciden
                    for (const keyword of data.keywords) {
                        if (messageLower.includes(keyword.toLowerCase())) {
                            matchCount++;
                        }
                    }

                    // Si esta categoría tiene más coincidencias, es mejor candidata
                    if (matchCount > maxMatches) {
                        maxMatches = matchCount;
                        bestMatch = data.response;
                    }
                }

                // Si encontramos una buena coincidencia, retornarla
                if (bestMatch && maxMatches > 0) {
                    return bestMatch;
                }

                // Default response if no match found
                return `Gracias por tu pregunta. Para ayudarte mejor, puedes:

        - Usar las preguntas frecuentes en el panel lateral
        - Contactar a nuestro equipo de soporte: soporte@medicitas.com
        - Llamar al +52 55 1234 5678

        ¿Hay algo más específico con lo que pueda ayudarte?`;
            }

            // Ask predefined question
            function askPredefinedQuestion(question) {
                chatInput.value = question;
                sendMessage();
            }

            // Provide feedback
            function provideFeedback(type) {
                const message = type === 'helpful'
                    ? '¡Gracias por tu feedback! Nos alegra haber sido de ayuda.'
                    : 'Gracias por tu feedback. ¿Te gustaría contactar con soporte directo?';

                // Mostrar mensaje con SweetAlert2 si está disponible, sino usar alert
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: type === 'helpful' ? 'success' : 'info',
                        title: type === 'helpful' ? '¡Gracias!' : 'Feedback recibido',
                        text: message,
                        confirmButtonText: 'OK',
                        timer: 3000
                    });
                } else {
                    alert(message);
                }
            }

            // Filter by category
            function filterByCategory(category) {
                const categoryMessages = {
                    'appointments': '¿Tienes preguntas sobre gestión de citas? Puedo ayudarte con programar, cancelar o reprogramar citas.',
                    'account': '¿Necesitas ayuda con tu cuenta? Puedo ayudarte con perfil, contraseña y configuración.',
                    'technical': '¿Problemas técnicos? Estoy aquí para ayudarte a resolverlos.',
                    'billing': '¿Preguntas sobre facturación? Puedo ayudarte con pagos y facturas.'
                };

                const message = categoryMessages[category] || 'Selecciona una categoría para más información.';
                addBotMessage(message);
            }

            // Toggle floating chat
            function toggleFloatingChat() {
                // Implementation for floating chat toggle
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'info',
                        title: 'Chat Flotante',
                        text: 'Funcionalidad próximamente disponible',
                        confirmButtonText: 'Entendido'
                    });
                } else {
                    alert('Chat flotante - Funcionalidad próximamente');
                }
            }

            // Scroll to bottom of chat
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // Initialize chat
            document.addEventListener('DOMContentLoaded', function() {
                scrollToBottom();

                // Focus en el input del chat
                if (chatInput) {
                    chatInput.focus();
                }
            });
    </script>
}